# Implementation Brief: HTML Attribute Graph Storage Refactor

## Overview

This document describes a breaking change to how HTML attributes are stored in the MGraph structure within the `Html_MGraph__Attributes` graph. The change addresses a fundamental design flaw discovered when handling HTML boolean attributes (attributes without values).

---

## Table of Contents

1. [Background & Context](#1-background--context)
2. [Current Implementation](#2-current-implementation)
3. [Problem Discovery](#3-problem-discovery)
4. [Root Cause Analysis](#4-root-cause-analysis)
5. [Proposed Solution](#5-proposed-solution)
6. [Implementation Details](#6-implementation-details)
7. [Migration & Breaking Changes](#7-migration--breaking-changes)
8. [Testing Strategy](#8-testing-strategy)

---

## 1. Background & Context

### The Html_MGraph Architecture

The `Html_MGraph` system represents HTML documents as a collection of interconnected MGraph structures:

- **Body Graph** - DOM element hierarchy (parent-child relationships)
- **Head Graph** - Head section elements
- **Attributes Graph** - Tags and their attributes
- **Scripts Graph** - Script content
- **Styles Graph** - Style content
- **Document Graph** - Meta-view connecting all subgraphs

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Html_MGraph                                    │
│                           (Facade Class)                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│    ┌─────────────┐    ┌─────────────┐    ┌─────────────────────────────┐    │
│    │             │    │             │    │                             │    │
│    │  Head Graph │    │  Body Graph │    │     Attributes Graph        │    │
│    │             │    │             │    │                             │    │
│    │  <head>     │    │  <body>     │    │  Tags + Attributes          │    │
│    │    ├─title  │    │    ├─div    │    │                             │    │
│    │    ├─meta   │    │    │  ├─p   │    │  ┌─────┐     ┌──────────┐   │    │
│    │    └─link   │    │    │  └─h1  │    │  │ tag │────▶│ element  │   │    │
│    │             │    │    └─form   │    │  └─────┘     └──────────┘   │    │
│    └──────┬──────┘    └──────┬──────┘    │       │            │        │    │
│           │                  │           │       ▼            ▼        │    │
│           │                  │           │  ┌─────────┐  ┌────────┐    │    │
│           │                  │           │  │  attr   │  │  attr  │    │    │
│           │                  │           │  └─────────┘  └────────┘    │    │
│           │                  │           └─────────────────────────────┘    │
│           │                  │                        │                     │
│           │                  │                        │                     │
│    ┌──────┴──────┐    ┌──────┴──────┐    ┌────────────┴────────────┐        │
│    │             │    │             │    │                         │        │
│    │Scripts Graph│    │Styles Graph │    │     Document Graph      │        │
│    │             │    │             │    │     (Meta-View)         │        │
│    │  <script>   │    │  <style>    │    │                         │        │
│    │  content    │    │  CSS rules  │    │  html ──▶ [5 subgraphs] │        │
│    │             │    │             │    │                         │        │
│    └─────────────┘    └─────────────┘    └─────────────────────────┘        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Full Document Visualization (Clustered View)

When rendered with the "Full Document" transformation, all subgraphs appear as colored clusters:

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                                                                                  │
│  ┌─────────────┐  ┌──────────────────┐  ┌────────────────────────────────────┐   │
│  │    Head     │  │       Body       │  │            Attributes              │   │
│  │   (blue)    │  │     (green)      │  │             (orange)               │   │
│  │             │  │                  │  │                                    │   │
│  │  ┌──────┐   │  │  ┌──────┐        │  │  ┌──────┐ ┌──────┐ ┌──────┐        │   │
│  │  │<head>│   │  │  │<body>│        │  │  │<html>│ │<body>│ │<div> │ ...    │   │
│  │  └──┬───┘   │  │  └──┬───┘        │  │  └──┬───┘ └──┬───┘ └──┬───┘        │   │
│  │     │       │  │     │            │  │     │        │        │            │   │
│  │  ┌──▼───┐   │  │  ┌──▼───┐        │  │     ▼        ▼        ▼            │   │
│  │  │<title│   │  │  │<div> │        │  │  ┌──────────────────────────┐      │   │
│  │  └──┬───┘   │  │  └──┬───┘        │  │  │      element nodes       │      │   │
│  │     │       │  │     ├────┐       │  │  └──────────────────────────┘      │   │
│  │  ┌──▼────┐  │  │  ┌──▼──┐ ▼───┐   │  │              │                     │   │
│  │  │"Title"│  │  │  │<p>  │ │<h1│   │  │              ▼                     │   │
│  │  └───────┘  │  │  └──┬──┘ └─┬─┘   │  │  ┌──────────────────────────┐      │   │
│  │             │  │     │      │     │  │  │    attribute nodes       │      │   │
│  └─────────────┘  │  ┌──▼──┐┌──▼──┐  │  │  └──────────────────────────┘      │   │
│                   │  │text ││text │  │  │                                    │   │
│                   │  └─────┘└─────┘  │  └────────────────────────────────────┘   │
│                   └──────────────────┘                                           │
│                                                                                  │
│  ┌─────────────┐  ┌─────────────┐                                                │
│  │   Scripts   │  │   Styles    │      ─────  solid edges (parent-child)         │
│  │   (pink)    │  │  (purple)   │      ─ ─ ─  dashed edges (cross-reference)     │
│  └─────────────┘  └─────────────┘                                                │
│                                                                                  │
└──────────────────────────────────────────────────────────────────────────────────┘
```

### The HTML Processing Pipeline

```
HTML String → Html-Dict → Html_MGraph → [Processing] → Html_MGraph → Html-Dict → HTML String
```

#### Detailed Pipeline Flow

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                           HTML PROCESSING PIPELINE                                       │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                                    FORWARD PATH
┌──────────┐      ┌──────────┐      ┌──────────────┐      ┌──────────────┐
│          │      │          │      │              │      │              │
│   HTML   │─────▶│ Html-Dict│─────▶│  Html_MGraph │─────▶│  Processing  │
│  String  │      │   (JSON) │      │   (Graphs)   │      │  & Analysis  │
│          │      │          │      │              │      │              │
└──────────┘      └──────────┘      └──────────────┘      └──────────────┘
                                                                 │
     Html__To__Dict    Html__To__Html_MGraph__Document           │
                                                                 │
  ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│─ ─ ─ ─ ─
                                                                 │
                                    REVERSE PATH                 │
┌──────────┐      ┌──────────┐      ┌──────────────┐             │
│          │      │          │      │              │             │
│   HTML   │◀─────│ Html-Dict│◀─────│  Html_MGraph │◀────────────┘
│  String  │      │   (JSON) │      │   (Graphs)   │
│          │      │          │      │              │
└──────────┘      └──────────┘      └──────────────┘

     Html_Dict__To__Html    Html_MGraph__Document__To__Html_Dict


┌─────────────────────────────────────────────────────────────────────────────────────────┐
│  KEY INSIGHT: Html ↔ Html-Dict roundtrip ALREADY handles boolean attributes correctly!  │
│               The bug is specifically in Html-Dict ↔ Html_MGraph conversion.            │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

#### Boolean Attribute Flow (Working vs Broken)

```
                    ✅ WORKING                           ❌ BROKEN
              (Html ↔ Html-Dict)                  (Html-Dict → Html_MGraph)

┌─────────────────────────────┐          ┌─────────────────────────────┐
│  <input required>           │          │  {"required": null}         │
└──────────────┬──────────────┘          └──────────────┬──────────────┘
               │                                        │
               ▼                                        ▼
┌─────────────────────────────┐          ┌─────────────────────────────┐
│  {                          │          │  add_attribute(             │
│    "tag": "input",          │          │      node_id,               │
│    "attrs": {               │          │      "required",            │
│      "required": null  ◀────┼── OK!    │      None  ◀────────────────┼── CRASH!
│    }                        │          │  )                          │
│  }                          │          │                             │
└──────────────┬──────────────┘          │  ValueError: 'attr_value'   │
               │                         │  is not optional but got    │
               ▼                         │  None                       │
┌─────────────────────────────┐          └─────────────────────────────┘
│  <input required />    ◀────┼── OK!
└─────────────────────────────┘
```

```python
# Input HTML
"<input required>"

# Html-Dict representation (correctly parsed)
{
    "tag": "input",
    "attrs": {
        "required": null  # null represents boolean attribute
    },
    "nodes": []
}

# Reconstructed HTML (correct!)
"<input required />"
```

The problem occurs in the **Html-Dict → Html_MGraph** conversion layer.

---

## 2. Current Implementation

### Current Attribute Storage Model

In the current implementation, attributes are stored with this structure:

```
element_node ──edge──→ attr_value_node
             │
             ├── edge.predicate = "attr"
             └── edge.edge_path = "{attr_name}"     (e.g., "class")
             
             attr_value_node.value = "{attr_value}"  (e.g., "container")
             attr_value_node.node_path = "{position}" (e.g., "0")
```

#### Current Model Diagram

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                     CURRENT ATTRIBUTE STORAGE MODEL                             │
└─────────────────────────────────────────────────────────────────────────────────┘

Example: <div class="container" id="main">

┌───────────────────┐                    ┌───────────────────┐
│                   │                    │                   │
│   element_node    │     predicate:     │  attr_value_node  │
│                   │       "attr"       │                   │
│   node_path:      │    edge_path:      │   node_path: "0"  │
│   "body.div"      │─────"class"───────▶│   value:          │
│                   │                    │   "container"     │
│                   │                    │                   │
└───────────────────┘                    └───────────────────┘
         │
         │                               ┌───────────────────┐
         │           predicate:          │                   │
         │             "attr"            │  attr_value_node  │
         │          edge_path:           │                   │
         └─────────────"id"─────────────▶│   node_path: "1"  │
                                         │   value: "main"   │
                                         │                   │
                                         └───────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  PROBLEM: Where does the attribute NAME go for boolean attrs with no VALUE?     │
│                                                                                 │
│  <input required>  →  attr_value_node.value = ???                               │
│                       attr_value_node.node_path = "0" (position, not name!)     │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### Current `add_attribute()` Method

```python
@type_safe
def add_attribute(self, node_id    : Node_Id,
                        attr_name  : str,
                        attr_value : str,      # Problem: Required, cannot be None
                        position   : int = 0
                 ) -> Node_Id:
    attr_node = self.new_value_node(
        value     = attr_value,
        node_path = Node_Path(str(position))
    )
    self.new_edge(
        from_node_id = node_id,
        to_node_id   = attr_node.node_id,
        predicate    = self.PREDICATE_ATTR,
        edge_path    = Edge_Path(attr_name)
    )
    return attr_node.node_id
```

### Current `get_attributes()` Method

```python
def get_attributes(self, node_id: Node_Id) -> Dict[str, str]:
    attrs = []
    edges = self.outgoing_edges(node_id)
    
    for edge in edges:
        if self.edge_predicate(edge) == self.PREDICATE_ATTR:
            attr_name     = str(self.edge_path(edge))
            attr_node_id  = edge.edge.data.to_node_id
            attr_value    = self.node_value(attr_node_id)
            position_path = self.node_path(attr_node_id)
            position      = int(str(position_path)) if position_path else 0
            attrs.append((position, attr_name, attr_value))
    
    attrs.sort(key=lambda x: x[0])
    return {name: value for _, name, value in attrs}
```

---

## 3. Problem Discovery

### Initial Error

When processing HTML with boolean attributes, the system crashed:

```
ValueError: Parameter 'attr_value' is not optional but got None
```

### Discovery Process

The bug was discovered using the project's HTML Graph visualization UI:

1. **User loaded HTML with form elements:**
   ```html
   <form id="contact-form" class="form-horizontal" method="post" action="/submit">
       <div class="form-group required">
           <label for="name" class="control-label">Name</label>
           <input type="text" id="name" name="name" class="form-control" 
                  placeholder="Enter your name" required>
       </div>
   </form>
   ```

2. **API returned error** - The `required` attribute (boolean, no value) caused crash

3. **Minimal reproduction** - Isolated to:
   ```html
   <input required>
   ```

4. **Verified Html-Dict handles it correctly:**
   
   | HTML Input | Html-Dict | Roundtrip Output |
   |------------|-----------|------------------|
   | `<input required>` | `{"required": null}` | `<input required />` |
   | `<input required="aaaa">` | `{"required": "aaaa"}` | `<input required="aaaa" />` |
   | `<input bbb>` | `{"bbb": null}` | `<input bbb />` |
   | `<input bbb="cccc">` | `{"bbb": "cccc"}` | `<input bbb="cccc" />` |

   The HTML parser correctly produces `null` for boolean attributes, and the HTML reconstructor correctly renders them without values.

---

## 4. Root Cause Analysis

### The Core Problem

The current model conflates two distinct concepts:

1. **Attribute name** - Always required (e.g., `required`, `class`, `disabled`)
2. **Attribute value** - Optional (e.g., `null` for boolean, `"container"` for valued)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         THE FUNDAMENTAL CONFLATION                              │
└─────────────────────────────────────────────────────────────────────────────────┘

    CURRENT MODEL: Single node stores BOTH name reference AND value

    ┌─────────────────────────────────────────────────────────────────────────┐
    │                        attr_value_node                                  │
    │  ┌─────────────────────────────────────────────────────────────────┐    │
    │  │  node_path = position ("0", "1", ...)                           │    │
    │  │  value     = attr_value ("container", "main", ...)              │    │
    │  │                                                                 │    │
    │  │  ❌ attr_name stored ONLY on incoming edge.edge_path            │    │
    │  │  ❌ No way to represent "has name but no value" (boolean attr)  │    │
    │  └─────────────────────────────────────────────────────────────────┘    │
    └─────────────────────────────────────────────────────────────────────────┘

    WHAT WE NEED: Separate concepts for name, value, and position

    ┌──────────────┐      ┌──────────────┐      ┌──────────────┐
    │   POSITION   │      │     NAME     │      │    VALUE     │
    │              │      │              │      │  (optional)  │
    │   Always     │      │   Always     │      │              │
    │   required   │      │   required   │      │   Only for   │
    │              │      │              │      │   non-bool   │
    └──────────────┘      └──────────────┘      └──────────────┘
```

### Attempted Fixes (Hacky)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           ATTEMPTED FIX #1                                      │
│                    Make attr_value optional, use empty string                   │
└─────────────────────────────────────────────────────────────────────────────────┘

    Code:
    ┌────────────────────────────────────────────────────────────────────────┐
    │  if attr_value is None:                                                │
    │      attr_node = self.new_element_node(node_path=Node_Path(str(pos)))  │
    └────────────────────────────────────────────────────────────────────────┘

    Result in graph visualization:

    ┌───────────┐         ┌───────────┐
    │  element  │──attr──▶│    "0"    │  ◀── Shows position, not name!
    └───────────┘         └───────────┘

    ❌ PROBLEM: Graph shows "0" instead of "required"


┌─────────────────────────────────────────────────────────────────────────────────┐
│                           ATTEMPTED FIX #2                                      │
│                    Store attr_name in node_path for boolean                     │
└─────────────────────────────────────────────────────────────────────────────────┘

    Code:
    ┌────────────────────────────────────────────────────────────────────────┐
    │  if attr_value is None:                                                │
    │      attr_node = self.new_element_node(node_path=attr_name)            │
    └────────────────────────────────────────────────────────────────────────┘

    Result in get_attributes():

    ┌────────────────────────────────────────────────────────────────────────┐
    │  position = int(str(position_path))                                    │
    │  # ValueError: invalid literal for int(): 'required'                   │
    └────────────────────────────────────────────────────────────────────────┘

    ❌ PROBLEM: Roundtrip crashes - expects position (int), gets name (str)


┌─────────────────────────────────────────────────────────────────────────────────┐
│                           ATTEMPTED FIX #3                                      │
│                    Always use position, accept empty string value               │
└─────────────────────────────────────────────────────────────────────────────────┘

    Input:   <input required>
    Output:  <input required="">

    ❌ PROBLEM: Loses boolean semantics, produces invalid HTML
```

### Attempted Fixes (Hacky)

**Attempt 1: Make `attr_value` optional, use empty string**
```python
attr_value: str = None
if attr_value is None:
    attr_node = self.new_element_node(node_path=Node_Path(str(position)))
```

**Problem:** Graph shows `"0"` instead of `"required"` - the attribute name is lost in the node itself.

**Attempt 2: Store attr_name in node_path for boolean attrs**
```python
if attr_value is None:
    attr_node = self.new_element_node(node_path=attr_name)
```

**Problem:** Roundtrip fails - `get_attributes()` expects `node_path` to be position (integer), not name:
```python
position = int(str(position_path))  # ValueError: invalid literal for int() with base 10: 'required'
```

**Attempt 3: Always use position, accept `""`**

**Problem:** Roundtrip produces `<input required="">` instead of `<input required>` - loses boolean semantics.

### Fundamental Issue

The single-node model cannot cleanly represent:
- Attribute name (always present)
- Attribute value (optional)
- Attribute position (always present)

Plus, there's no node reuse - every attribute creates new nodes even for common names like `class`, `id`, `type`.

---

## 5. Proposed Solution

### New Attribute Storage Model

Introduce an **attribute instance node** that separates name and value:

```
element_node ──edge(predicate='attr')──→ attr_instance_node
                                               │
                                               ├──edge(predicate='name')──→  name_node (shared)
                                               │
                                               └──edge(predicate='value')──→ value_node (shared, optional)

attr_instance_node.node_path = "{position}"  (e.g., "0", "1", "2")
name_node.value = "{attr_name}"              (e.g., "class", "required")
value_node.value = "{attr_value}"            (e.g., "container", "btn-primary")
```

### Architecture Comparison: Before vs After

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              BEFORE (Current)                                   │
│                         Single Node per Attribute                               │
└─────────────────────────────────────────────────────────────────────────────────┘

    <input class="form-control" required>

                                 ┌─────────────────┐
                    edge_path:   │  value_node     │
    ┌─────────┐     "class"      │                 │
    │ element │─────────────────▶│  path: "0"      │
    │  node   │                  │  value: "form-  │
    │         │                  │   control"      │
    └─────────┘                  └─────────────────┘
         │
         │                       ┌─────────────────┐
         │       edge_path:      │  value_node     │
         │       "required"      │                 │
         └──────────────────────▶│  path: "1"      │
                                 │  value: ???     │  ◀── PROBLEM!
                                 └─────────────────┘

    Issues:
    • No value for boolean attrs
    • No node reuse
    • Name only in edge, not queryable


┌─────────────────────────────────────────────────────────────────────────────────┐
│                               AFTER (Proposed)                                  │
│                    Three-Node Model with Reuse                                  │
└─────────────────────────────────────────────────────────────────────────────────┘

    <input class="form-control" required>

    ┌─────────┐       ┌──────────────┐       ┌────────────┐       ┌──────────────┐
    │ element │─attr─▶│ instance_A   │─name─▶│  "class"   │◀─name─│ instance_C   │
    │  node   │       │  path: "0"   │       │ (shared)   │       │  path: "0"   │
    │         │       └──────────────┘       └────────────┘       └──────────────┘
    │ (input) │             │                                           │
    │         │             │ value                                     │ value
    └─────────┘             ▼                                           ▼
         │           ┌──────────────┐                             ┌──────────────┐
         │           │ "form-       │                             │ "btn-        │
         │           │  control"    │                             │  primary"    │
         │           └──────────────┘                             └──────────────┘
         │
         │           ┌──────────────┐       ┌────────────┐       ┌──────────────┐
         └───attr───▶│ instance_B   │─name─▶│ "required" │◀─name─│ instance_D   │
                     │  path: "1"   │       │ (shared)   │       │  path: "1"   │
                     └──────────────┘       └────────────┘       └──────────────┘
                            │                                         │
                            ╳  (no value edge = boolean!)             ╳

    Benefits:
    ✅ Boolean attrs = no value edge
    ✅ Name nodes reused across elements
    ✅ Value nodes reused for common values
    ✅ Position stored on instance node
```

### Key Design Decisions

1. **Boolean attributes** = attr_instance with name edge but NO value edge
2. **Position** stored on attr_instance_node.node_path
3. **Name nodes are reused** - all `class` attributes share one name node
4. **Value nodes are reused** - common values like `"true"`, `"container"` shared
5. **Clean semantics** - presence/absence of value edge indicates boolean vs valued

### Detailed Node & Edge Structure

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                      COMPLETE GRAPH STRUCTURE EXAMPLE                           │
└─────────────────────────────────────────────────────────────────────────────────┘

    HTML:
    ┌────────────────────────────────────────────────────────────────────────┐
    │  <input class="form-control" required>                                 │
    │  <input class="btn-primary" required>                                  │
    └────────────────────────────────────────────────────────────────────────┘

    NODES:
    ┌──────────────┬───────────────┬─────────────────┬─────────────────────┐
    │   Node ID    │     Type      │    node_path    │       value         │
    ├──────────────┼───────────────┼─────────────────┼─────────────────────┤
    │ element_1    │ element       │ body.input[0]   │ -                   │
    │ element_2    │ element       │ body.input[1]   │ -                   │
    │ instance_A   │ element       │ 0               │ -                   │
    │ instance_B   │ element       │ 1               │ -                   │
    │ instance_C   │ element       │ 0               │ -                   │
    │ instance_D   │ element       │ 1               │ -                   │
    │ name_class   │ value         │ name            │ "class"             │
    │ name_req     │ value         │ name            │ "required"          │
    │ val_form     │ value         │ value           │ "form-control"      │
    │ val_btn      │ value         │ value           │ "btn-primary"       │
    └──────────────┴───────────────┴─────────────────┴─────────────────────┘

    EDGES:
    ┌──────────────┬──────────────┬─────────────┬───────────────────────────┐
    │     From     │      To      │  Predicate  │         Purpose           │
    ├──────────────┼──────────────┼─────────────┼───────────────────────────┤
    │ element_1    │ instance_A   │ attr        │ element has attribute     │
    │ element_1    │ instance_B   │ attr        │ element has attribute     │
    │ element_2    │ instance_C   │ attr        │ element has attribute     │
    │ element_2    │ instance_D   │ attr        │ element has attribute     │
    │ instance_A   │ name_class   │ name        │ attr name is "class"      │
    │ instance_A   │ val_form     │ value       │ attr value is "form-..."  │
    │ instance_B   │ name_req     │ name        │ attr name is "required"   │
    │ instance_B   │ (none)       │ -           │ ← BOOLEAN (no value!)     │
    │ instance_C   │ name_class   │ name        │ REUSED name node!         │
    │ instance_C   │ val_btn      │ value       │ attr value is "btn-..."   │
    │ instance_D   │ name_req     │ name        │ REUSED name node!         │
    │ instance_D   │ (none)       │ -           │ ← BOOLEAN (no value!)     │
    └──────────────┴──────────────┴─────────────┴───────────────────────────┘

    NODE COUNT COMPARISON:
    ┌─────────────────────────┬─────────────┬─────────────┐
    │                         │   Before    │    After    │
    ├─────────────────────────┼─────────────┼─────────────┤
    │ Elements                │      2      │      2      │
    │ Attr instances          │      -      │      4      │
    │ Name nodes              │      -      │      2      │ (reused!)
    │ Value nodes             │      4*     │      2      │ (reused!)
    ├─────────────────────────┼─────────────┼─────────────┤
    │ TOTAL                   │   6 nodes   │  10 nodes   │
    │ * boolean attrs crash   │             │             │
    └─────────────────────────┴─────────────┴─────────────┘

    Note: While node count increases, the semantic clarity and
    deduplication benefits scale well for larger documents.
```

### Visual Example

```html
<input class="form-control" required>
<input class="btn-primary" required>
```

**Graph Structure:**

```
element_1 ──attr──→ instance_A (path='0') ──name──→  "class" (SHARED)
                                          ──value──→ "form-control"
                                          
          ──attr──→ instance_B (path='1') ──name──→  "required" (SHARED)
                                          (no value edge = boolean attr)

element_2 ──attr──→ instance_C (path='0') ──name──→  "class" (SAME NODE!)
                                          ──value──→ "btn-primary"
                                          
          ──attr──→ instance_D (path='1') ──name──→  "required" (SAME NODE!)
                                          (no value edge = boolean attr)
```

**Node Table:**

| Node ID | Type | node_path | value |
|---------|------|-----------|-------|
| element_1 | element | `body.input[0]` | - |
| element_2 | element | `body.input[1]` | - |
| instance_A | element | `0` | - |
| instance_B | element | `1` | - |
| instance_C | element | `0` | - |
| instance_D | element | `1` | - |
| name_class | value | `name` | `"class"` |
| name_required | value | `name` | `"required"` |
| val_form_control | value | `value` | `"form-control"` |
| val_btn_primary | value | `value` | `"btn-primary"` |

**Edge Table:**

| From | To | Predicate | edge_path |
|------|----|-----------|-----------|
| element_1 | instance_A | `attr` | - |
| element_1 | instance_B | `attr` | - |
| element_2 | instance_C | `attr` | - |
| element_2 | instance_D | `attr` | - |
| instance_A | name_class | `name` | - |
| instance_A | val_form_control | `value` | - |
| instance_B | name_required | `name` | - |
| instance_C | name_class | `name` | - |
| instance_C | val_btn_primary | `value` | - |
| instance_D | name_required | `name` | - |

---

## 6. Implementation Details

### Algorithm Flow: get_attributes()

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    get_attributes(element_id) ALGORITHM                         │
└─────────────────────────────────────────────────────────────────────────────────┘

                              START
                                │
                                ▼
                    ┌───────────────────────┐
                    │  Get all outgoing     │
                    │  edges from element   │
                    └───────────┬───────────┘
                                │
                                ▼
                   ┌───────────────────────┐
        ┌──────────│  For each edge        │──────────┐
        │          └───────────────────────┘          │
        │                                             │
        ▼                                             │
┌───────────────────┐                                 │
│ predicate='attr'? │──No──────────────────────┐      │
└────────┬──────────┘                          │      │
         │ Yes                                 │      │
         ▼                                     │      │
┌────────────────────┐                         │      │
│ Get instance_node  │                         │      │
│ (edge.to_node_id)  │                         │      │
└────────┬───────────┘                         │      │
         │                                     │      │
         ▼                                     │      │
┌────────────────────┐                         │      │
│ Get position from  │                         │      │
│ instance.node_path │                         │      │
└────────┬───────────┘                         │      │
         │                                     │      │
         ▼                                     │      │
┌────────────────────┐                         │      │
│ Get instance's     │                         │      │
│ outgoing edges     │                         │      │
└────────┬───────────┘                         │      │
         │                                     │      │
         ├─────────────────────┐               │      │
         │                     │               │      │
         ▼                     ▼               │      │
┌─────────────────┐  ┌─────────────────┐       │      │
│ pred='name'?    │  │ pred='value'?   │       │      │
└────────┬────────┘  └────────┬────────┘       │      │
         │ Yes                │ Yes            │      │
         ▼                    ▼                │      │
┌─────────────────┐  ┌─────────────────┐       │      │
│ attr_name =     │  │ attr_value =    │       │      │
│ node.value      │  │ node.value      │       │      │
└────────┬────────┘  └────────┬────────┘       │      │
         │                    │                │      │
         └────────┬───────────┘                │      │
                  │                            │      │
                  ▼                            │      │
         ┌────────────────────┐                │      │
         │ No value edge?     │                │      │
         │ attr_value = None  │                │      │
         │ (boolean attr!)    │                │      │
         └────────┬───────────┘                │      │
                  │                            │      │
                  ▼                            │      │
         ┌────────────────────┐                │      │
         │ Append to attrs:   │                │      │
         │ (pos, name, value) │                │      │
         └────────┬───────────┘                │      │
                  │                            │      │
                  └────────────┬───────────────┘      │
                               │                      │
                               │◀─────────────────────┘
                               │
                               ▼
                    ┌───────────────────────┐
                    │  Sort attrs by        │
                    │  position             │
                    └───────────┬───────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │  Return Dict:         │
                    │  {name: value, ...}   │
                    │  (value can be None)  │
                    └───────────────────────┘
                                │
                                ▼
                              END
```

### Updated Constants

```python
class Html_MGraph__Attributes(Html_MGraph__Graph):
    PREDICATE_ATTR  = 'attr'    # element → attr_instance
    PREDICATE_NAME  = 'name'    # attr_instance → name_node
    PREDICATE_VALUE = 'value'   # attr_instance → value_node (optional)
    
    NODE_PATH_NAME  = 'name'    # node_path for name nodes
    NODE_PATH_VALUE = 'value'   # node_path for value nodes
```

### New `add_attribute()` Method

```python
@type_safe
def add_attribute(self, node_id    : Node_Id,
                        attr_name  : str,
                        attr_value : Optional[str] = None,
                        position   : int = 0
                 ) -> Node_Id:
    """Add an attribute to an element.
    
    Creates:
    - attr_instance_node (new, stores position)
    - name_node (reused if same name exists)
    - value_node (reused if same value exists, omitted if attr_value is None)
    
    Args:
        node_id: Element node to add attribute to
        attr_name: Attribute name (e.g., "class", "required")
        attr_value: Attribute value (None for boolean attributes)
        position: Position for ordering (0, 1, 2, ...)
    
    Returns:
        Node_Id of the attr_instance_node
    """
    # 1. Create attr_instance node (always new, stores position)
    instance_node = self.new_element_node(
        node_path=Node_Path(str(position))
    )
    
    # 2. Link element → attr_instance
    self.new_edge(
        from_node_id = node_id,
        to_node_id   = instance_node.node_id,
        predicate    = self.PREDICATE_ATTR
    )
    
    # 3. Get or create name node (reused)
    name_node = self._get_or_create_name_node(attr_name)
    
    # 4. Link attr_instance → name
    self.new_edge(
        from_node_id = instance_node.node_id,
        to_node_id   = name_node.node_id,
        predicate    = self.PREDICATE_NAME
    )
    
    # 5. If value exists, get or create value node and link
    if attr_value is not None:
        value_node = self._get_or_create_value_node(attr_value)
        self.new_edge(
            from_node_id = instance_node.node_id,
            to_node_id   = value_node.node_id,
            predicate    = self.PREDICATE_VALUE
        )
    
    return instance_node.node_id


def _get_or_create_name_node(self, attr_name: str) -> Node:
    """Get existing name node or create new one."""
    # Look for existing name node with this value
    for node_id in self.nodes_ids():
        if self.node_path(node_id) == self.NODE_PATH_NAME:
            if self.node_value(node_id) == attr_name:
                return self.node(node_id)
    
    # Create new name node
    return self.new_value_node(
        value     = attr_name,
        node_path = Node_Path(self.NODE_PATH_NAME)
    )


def _get_or_create_value_node(self, attr_value: str) -> Node:
    """Get existing value node or create new one."""
    # Look for existing value node with this value
    for node_id in self.nodes_ids():
        if self.node_path(node_id) == self.NODE_PATH_VALUE:
            if self.node_value(node_id) == attr_value:
                return self.node(node_id)
    
    # Create new value node
    return self.new_value_node(
        value     = attr_value,
        node_path = Node_Path(self.NODE_PATH_VALUE)
    )
```

### New `get_attributes()` Method

```python
def get_attributes(self, node_id: Node_Id) -> Dict[str, Optional[str]]:
    """Get all attributes for an element (ordered).
    
    Returns:
        Dict mapping attr_name → attr_value (None for boolean attributes)
    """
    attrs = []
    
    # Find all attr_instance nodes for this element
    for edge in self.outgoing_edges(node_id):
        if self.edge_predicate(edge) == self.PREDICATE_ATTR:
            instance_id = edge.edge.data.to_node_id
            
            # Get position from instance node's path
            position_path = self.node_path(instance_id)
            position = int(str(position_path)) if position_path else 0
            
            # Find name and value from instance's outgoing edges
            attr_name = None
            attr_value = None
            
            for inner_edge in self.outgoing_edges(instance_id):
                inner_pred = self.edge_predicate(inner_edge)
                inner_target = inner_edge.edge.data.to_node_id
                
                if inner_pred == self.PREDICATE_NAME:
                    attr_name = self.node_value(inner_target)
                elif inner_pred == self.PREDICATE_VALUE:
                    attr_value = self.node_value(inner_target)
            
            if attr_name:
                attrs.append((position, attr_name, attr_value))
    
    # Sort by position and return as dict
    attrs.sort(key=lambda x: x[0])
    return {name: value for _, name, value in attrs}
```

### Update Return Type in Dependent Code

**`Html_MGraph__Document.get_attributes()`:**
```python
def get_attributes(self, node_id: Node_Id) -> Dict[str, Optional[str]]:  # Updated return type
    return self.attrs_graph.get_attributes(node_id)
```

**`Html_MGraph__Document__To__Html_Dict._build_body_dict()`:**
```python
# attrs dict now contains Optional[str] values, which maps to null in JSON
# This aligns with Html-Dict format: {"required": null}
```

---

## 7. Migration & Breaking Changes

### Breaking Changes

1. **Graph structure changed** - Existing serialized graphs will be incompatible
2. **Return type changed** - `get_attributes()` returns `Dict[str, Optional[str]]` instead of `Dict[str, str]`
3. **Node count increased** - Each attribute now creates 2-3 nodes instead of 1

### Migration Strategy

For this project, a clean break is acceptable since:
- Html_MGraph is regenerated from HTML source on each use
- No persistent storage of graph structures (yet)
- All consumers can be updated simultaneously

### Version Bump

This change warrants a minor version bump (e.g., `v0.1.7` → `v0.2.0`) to signal breaking change.

---

## 8. Testing Strategy

### Test Coverage Map

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           TEST COVERAGE MAP                                     │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                            UNIT TESTS                                           │
│                      (Html_MGraph__Attributes)                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  add_attribute()                      get_attributes()                          │
│  ┌─────────────────────────┐         ┌─────────────────────────┐                │
│  │ ✓ Normal attr w/ value  │         │ ✓ Returns correct dict  │                │
│  │ ✓ Boolean attr (None)   │         │ ✓ Handles None values   │                │
│  │ ✓ Empty string value    │         │ ✓ Maintains order       │                │
│  │ ✓ Position ordering     │         │ ✓ Multiple elements     │                │
│  │ ✓ Name node reuse       │         └─────────────────────────┘                │
│  │ ✓ Value node reuse      │                                                    │
│  └─────────────────────────┘                                                    │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                          INTEGRATION TESTS                                      │
│                         (Full Pipeline Roundtrip)                               │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌────────────┐    ┌──────────┐    ┌────────────┐    ┌──────────┐    ┌──────┐   │
│  │   HTML     │───▶│ Html-Dict│───▶│ Html_MGraph│───▶│ Html-Dict│───▶│ HTML │   │
│  │  Input     │    │          │    │            │    │          │    │Output│   │
│  └────────────┘    └──────────┘    └────────────┘    └──────────┘    └──────┘   │
│                                                                         │       │
│                                                                         ▼       │
│                                                              ┌──────────────┐   │
│  Test Cases:                                                 │   COMPARE    │   │
│  ┌─────────────────────────────────────────────────────┐     │  Input ==    │   │
│  │ • <input required>         → <input required>       │     │  Output?     │   │
│  │ • <input required="">      → <input required="">    │     └──────────────┘   │
│  │ • <input type="text" required class="x">            │                        │
│  │ • <form disabled><input readonly></form>            │                        │
│  │ • Mixed boolean and valued attributes               │                        │
│  └─────────────────────────────────────────────────────┘                        │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                         VISUALIZATION TESTS                                     │
│                        (Graph Rendering Validation)                             │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌───────────────────────────────────────────────────────────────────────┐      │
│  │                      Expected Graph Output                            │      │
│  │                                                                       │      │
│  │  For: <input class="x" required>                                      │      │
│  │                                                                       │      │
│  │  ┌─────────┐       ┌──────────┐       ┌─────────┐                     │      │
│  │  │ <input> │─attr─▶│ inst_0   │─name─▶│ "class" │                     │      │
│  │  └─────────┘       └────┬─────┘       └─────────┘                     │      │
│  │       │                 │ value                                       │      │
│  │       │                 ▼                                             │      │
│  │       │            ┌─────────┐                                        │      │
│  │       │            │   "x"   │                                        │      │
│  │       │            └─────────┘                                        │      │
│  │       │                                                               │      │
│  │       │           ┌──────────┐       ┌────────────┐                   │      │
│  │       └───attr───▶│ inst_1   │─name─▶│ "required" │                   │      │
│  │                   └──────────┘       └────────────┘                   │      │
│  │                        │                                              │      │
│  │                        ╳ (no value edge = boolean!)                   │      │
│  │                                                                       │      │
│  │  Assertions:                                                          │      │
│  │  • "required" label visible (not "1" or "0")                          │      │
│  │  • No value node connected to required's instance                     │      │
│  │  • Correct cluster assignment (Attributes cluster)                    │      │
│  └───────────────────────────────────────────────────────────────────────┘      │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### Unit Tests for `add_attribute()`

```python
def test_add_attribute__with_value(self):
    """Normal attribute with value."""
    attrs_graph.add_attribute(element_id, 'class', 'container', 0)
    attrs = attrs_graph.get_attributes(element_id)
    assert attrs == {'class': 'container'}

def test_add_attribute__boolean(self):
    """Boolean attribute (no value)."""
    attrs_graph.add_attribute(element_id, 'required', None, 0)
    attrs = attrs_graph.get_attributes(element_id)
    assert attrs == {'required': None}

def test_add_attribute__multiple_ordered(self):
    """Multiple attributes maintain order."""
    attrs_graph.add_attribute(element_id, 'type', 'text', 0)
    attrs_graph.add_attribute(element_id, 'required', None, 1)
    attrs_graph.add_attribute(element_id, 'class', 'form-control', 2)
    
    attrs = attrs_graph.get_attributes(element_id)
    assert list(attrs.keys()) == ['type', 'required', 'class']
    assert attrs['required'] is None

def test_add_attribute__name_reuse(self):
    """Same attr name reuses name node."""
    attrs_graph.add_attribute(element_1, 'class', 'a', 0)
    attrs_graph.add_attribute(element_2, 'class', 'b', 0)
    
    # Count nodes with path='name' and value='class'
    class_nodes = [n for n in attrs_graph.nodes_ids() 
                   if attrs_graph.node_value(n) == 'class']
    assert len(class_nodes) == 1  # Reused!

def test_add_attribute__value_reuse(self):
    """Same attr value reuses value node."""
    attrs_graph.add_attribute(element_1, 'type', 'text', 0)
    attrs_graph.add_attribute(element_2, 'type', 'text', 0)
    
    # Count nodes with path='value' and value='text'
    text_nodes = [n for n in attrs_graph.nodes_ids() 
                  if attrs_graph.node_value(n) == 'text']
    assert len(text_nodes) == 1  # Reused!
```

### Roundtrip Tests

```python
def test_roundtrip__boolean_attribute(self):
    """Boolean attribute roundtrips correctly."""
    html = "<html><body><input required /></body></html>"
    
    document = Html__To__Html_MGraph__Document().convert(html)
    result = Html_MGraph__Document__To__Html().convert(document)
    
    assert 'required' in result
    assert 'required=""' not in result  # Not empty string!

def test_roundtrip__mixed_attributes(self):
    """Mix of boolean and valued attributes."""
    html = '<input type="text" required class="form-control" disabled>'
    
    document = Html__To__Html_MGraph__Document().convert(html)
    result = Html_MGraph__Document__To__Html().convert(document)
    
    assert 'type="text"' in result
    assert 'class="form-control"' in result
    assert ' required' in result or 'required ' in result
    assert ' disabled' in result or 'disabled ' in result
    assert 'required=""' not in result
    assert 'disabled=""' not in result

def test_roundtrip__empty_vs_boolean(self):
    """Distinguish empty string from boolean."""
    # Empty string value
    html1 = '<input value="">'
    doc1 = Html__To__Html_MGraph__Document().convert(html1)
    attrs1 = doc1.get_attributes(input_node_id)
    assert attrs1['value'] == ''  # Empty string, not None
    
    # Boolean (no value)
    html2 = '<input required>'
    doc2 = Html__To__Html_MGraph__Document().convert(html2)
    attrs2 = doc2.get_attributes(input_node_id)
    assert attrs2['required'] is None  # None, not empty string
```

### Graph Visualization Tests

```python
def test_visualization__boolean_attr_shows_name(self):
    """Boolean attr shows name not position in graph."""
    html = '<input required>'
    # ... render graph
    # Assert node label is "required" not "0"

def test_visualization__attrs_cluster_correct(self):
    """Attributes appear in correct cluster."""
    html = '<input class="x" required>'
    # ... render with Full Document transformation
    # Assert both "class" and "required" nodes in Attributes cluster
```

---

## Appendix A: Thinking in Graphs

This refactor is a good example of **"thinking in graphs"** - using the visual representation to discover edge cases and design better data models.

### The Discovery Journey

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         PROBLEM DISCOVERY TIMELINE                              │
└─────────────────────────────────────────────────────────────────────────────────┘

    ┌──────────────────────────────────────────────────────────────────────────┐
    │  1. USER REPORTS ERROR                                                   │
    │     "API Error: Parameter 'attr_value' is not optional but got None"     │
    └──────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
    ┌──────────────────────────────────────────────────────────────────────────┐
    │  2. REPRODUCE IN UI                                                      │
    │     Load form HTML with <input required> in visualization tool           │
    └──────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
    ┌──────────────────────────────────────────────────────────────────────────┐
    │  3. ISOLATE MINIMAL CASE                                                 │
    │     <input required> - smallest HTML that triggers the bug               │
    └──────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
    ┌──────────────────────────────────────────────────────────────────────────┐
    │  4. CHECK TRANSFORMATION PLAYGROUND                                      │
    │     Html ↔ Html-Dict roundtrip works! {"required": null} → <input req>   │
    │     Bug is ONLY in Html-Dict → Html_MGraph conversion                    │
    └──────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
    ┌──────────────────────────────────────────────────────────────────────────┐
    │  5. ATTEMPTED FIXES (visualized in graph UI)                             │
    │     • Fix #1: Shows "0" instead of "required" ← Graph UI reveals issue!  │
    │     • Fix #2: Roundtrip crashes with ValueError                          │
    │     • Fix #3: Produces required="" - visible in output HTML              │
    └──────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
    ┌──────────────────────────────────────────────────────────────────────────┐
    │  6. DESIGN NEW MODEL                                                     │
    │     Graph structure should reflect semantic reality:                     │
    │     • Name and value are SEPARATE concepts                               │
    │     • Boolean attrs = presence of name, absence of value                 │
    │     • Use graph's natural strength: node reuse                           │
    └──────────────────────────────────────────────────────────────────────────┘
```

### Key Lessons Learned

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          LESSONS FROM THIS REFACTOR                             │
└─────────────────────────────────────────────────────────────────────────────────┘

    1. VISUAL DEBUGGING IS POWERFUL
    ───────────────────────────────
    
       ┌─────────────────────────────────────────────────────┐
       │  Graph visualization immediately showed "0" instead │
       │  of "required", revealing the label source problem  │
       │  that would have been hard to spot in code alone.   │
       └─────────────────────────────────────────────────────┘


    2. SEMANTIC MODELING MATTERS
    ────────────────────────────
    
       ┌─────────────────────────────────────────────────────┐
       │  Boolean attributes are semantically different from │
       │  valued attributes. The graph structure should      │
       │  reflect this: presence/absence of value edge.      │
       │                                                     │
       │  BAD:  required="" (forces empty value)             │
       │  GOOD: required (no value = boolean)                │
       └─────────────────────────────────────────────────────┘


    3. LEVERAGE GRAPH STRENGTHS
    ───────────────────────────
    
       ┌─────────────────────────────────────────────────────┐
       │  Graph databases excel at:                          │
       │  • Node sharing/reuse                               │
       │  • Representing optional relationships              │
       │  • Querying by relationship type                    │
       │                                                     │
       │  The new model leverages all three for names,       │
       │  values, and detecting boolean attributes.          │
       └─────────────────────────────────────────────────────┘


    4. TEST AT MULTIPLE LAYERS
    ──────────────────────────
    
       ┌─────────────────────────────────────────────────────┐
       │  The Html-Dict layer already worked correctly.      │
       │  By testing each layer independently, we pinpointed │
       │  the exact conversion step that was broken.         │
       │                                                     │
       │  HTML ↔ Html-Dict:      ✓ Working                   │
       │  Html-Dict ↔ MGraph:    ✗ Broken  ← Found it!       │
       │  MGraph ↔ Html-Dict:    ? Depends on above          │
       └─────────────────────────────────────────────────────┘


    5. ROUNDTRIP TESTS ARE ESSENTIAL
    ─────────────────────────────────
    
       ┌─────────────────────────────────────────────────────┐
       │  The simplest validation: input == output           │
       │                                                     │
       │  If <input required> becomes <input required="">    │
       │  the roundtrip test fails immediately, catching     │
       │  semantic loss that unit tests might miss.          │
       └─────────────────────────────────────────────────────┘
```

### The Power of Graph Visualization for Debugging

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│              WHY GRAPH VISUALIZATION ACCELERATED THIS FIX                       │
└─────────────────────────────────────────────────────────────────────────────────┘

    WITHOUT VISUALIZATION (Traditional Debugging):
    ──────────────────────────────────────────────
    
    1. Read error message
    2. Set breakpoints in code
    3. Step through debugger
    4. Print node IDs and values
    5. Mentally construct graph structure
    6. Guess at what's wrong
    7. Make change, re-run
    8. Repeat...
    
    Time: Hours of mental model building


    WITH VISUALIZATION (This Project):
    ───────────────────────────────────
    
    1. See error in UI
    2. Look at rendered graph
    3. Immediately spot "0" instead of "required"
    4. Understand the data model issue visually
    5. Design fix with visual goal in mind
    6. Implement and verify visually
    
    Time: Minutes of visual inspection

    ┌─────────────────────────────────────────────────────────────────────────┐
    │                                                                         │
    │   "A picture is worth a thousand print statements"                      │
    │                                                                         │
    │   The graph UI we built for this project turned a complex debugging     │
    │   session into a visual puzzle that was immediately apparent.           │
    │                                                                         │
    └─────────────────────────────────────────────────────────────────────────┘
```

---

## Appendix B: Files to Modify

1. `Html_MGraph__Attributes.py` - Core add/get methods
2. `Html_MGraph__Document.py` - Update return type annotation
3. `Html_MGraph__Document__To__Html_Dict.py` - Handle `None` values
4. `Html_MGraph__Data__Extractor.py` - Update attr extraction for visualization
5. `Html_MGraph__Render__Labels.py` - Update label generation for new structure
6. Tests - Update and add new tests

---

## Summary

| Aspect | Before | After |
|--------|--------|-------|
| Nodes per attribute | 1 | 2-3 (with reuse) |
| Boolean attr support | ❌ Crashes | ✅ Native |
| Name deduplication | ❌ None | ✅ Full |
| Value deduplication | ❌ None | ✅ Full |
| Roundtrip fidelity | ❌ `required=""` | ✅ `required` |
| Graph semantics | Conflated | Clean separation |

### Final Architecture Overview

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    FINAL ATTRIBUTE STORAGE ARCHITECTURE                         │
└─────────────────────────────────────────────────────────────────────────────────┘

    HTML INPUT                           GRAPH STRUCTURE
    ───────────                          ───────────────

    <input                               ┌─────────────────┐
       type="text"                       │    element      │
       class="form-control"              │    (input)      │
       required                          └────────┬────────┘
       disabled                                   │
    >                                             │ attr edges
                                                  │
                         ┌────────────────────────┼────────────────────────┐
                         │                        │                        │
                         ▼                        ▼                        ▼
                  ┌────────────┐          ┌────────────┐          ┌────────────┐
                  │ instance_0 │          │ instance_1 │          │ instance_2 │
                  │  (pos: 0)  │          │  (pos: 1)  │          │  (pos: 2)  │
                  └─────┬──────┘          └─────┬──────┘          └─────┬──────┘
                        │                       │                       │
               ┌────────┴────────┐      ┌───────┴───────┐       ┌───────┴───────┐
               │                 │      │               │       │               │
               ▼                 ▼      ▼               ▼       ▼               │
         ┌──────────┐     ┌──────────┐ ┌──────────┐     ╳  ┌──────────┐         ╳
         │  "type"  │     │  "text"  │ │ "class"  │        │"required"│
         │  (name)  │     │ (value)  │ │  (name)  │        │  (name)  │    (no value =
         └──────────┘     └──────────┘ └──────────┘        └──────────┘     boolean!)
                                             │
                                             ▼
                                       ┌──────────┐
                                       │ "form-   │
                                       │ control" │
                                       │ (value)  │
                                       └──────────┘

    ┌─────────────────────────────────────────────────────────────────────────────┐
    │  KEY INSIGHT: Boolean attributes have NO value edge from their instance.    │
    │               This cleanly models the semantic difference in HTML.          │
    │                                                                             │
    │  • <input required>      → instance ──name──▶ "required" (no value edge)    │
    │  • <input required="">   → instance ──name──▶ "required" ──value──▶ ""      │
    └─────────────────────────────────────────────────────────────────────────────┘


    NODE REUSE IN ACTION (Multiple Elements)
    ────────────────────────────────────────

    <input type="text" required>
    <input type="text" disabled>
    <button type="submit" disabled>

                                    ┌──────────────────┐
                  ┌────────────────▶│     "type"       │◀────────────────┐
                  │                 │   (name node)    │                 │
                  │                 │   SHARED x3      │                 │
                  │                 └──────────────────┘                 │
                  │                                                      │
           ┌──────┴──────┐    ┌─────────────┐    ┌─────────────┐   ┌─────┴──────┐
           │ input_1     │    │  input_2    │    │   button    │   │  instance  │
           │ instance    │    │  instance   │    │  instance   │   │    ...     │
           └──────┬──────┘    └──────┬──────┘    └──────┬──────┘   └────────────┘
                  │                  │                  │
                  │                  │                  │
                  ▼                  ▼                  ▼
           ┌──────────────────────────────────────────────────┐
           │                    "text"                        │
           │                 (value node)                     │
           │                  SHARED x2                       │
           └──────────────────────────────────────────────────┘


    ROUNDTRIP GUARANTEE
    ───────────────────

    ┌──────────────────┐         ┌──────────────────┐         ┌──────────────────┐
    │                  │         │                  │         │                  │
    │  <input          │  ────▶  │   Html_MGraph    │  ────▶  │  <input          │
    │    required      │         │   (with new      │         │    required      │
    │    type="text">  │         │    attr model)   │         │    type="text">  │
    │                  │         │                  │         │                  │
    └──────────────────┘         └──────────────────┘         └──────────────────┘
           INPUT                      PROCESS                      OUTPUT
                                                                     │
                                                                     │
                                    ┌────────────────────────────────┘
                                    │
                                    ▼
                              ┌───────────┐
                              │  INPUT    │
                              │    ==     │
                              │  OUTPUT   │
                              │    ✓      │
                              └───────────┘
```