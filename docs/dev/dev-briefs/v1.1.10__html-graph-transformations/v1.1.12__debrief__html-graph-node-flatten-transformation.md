# HTML Graph Node Flatten Transformation (Implementation Debrief)

**Version** v1.1.12

## Overview

This document describes a graph-based transformation pipeline that converts HTML documents into simplified, flattened text representations while preserving content order. The workflow uses MGraph-DB to represent HTML as a property graph, then applies a series of transformations to collapse formatting elements and merge text content.

## Business Value

This transformation is useful for:

- **Text extraction** — Strip formatting tags while preserving readable content
- **Content indexing** — Create searchable text from HTML documents
- **Semantic analysis** — Reduce HTML to its essential text structure
- **Data normalization** — Standardize varied HTML structures into uniform representations

---

## Example 1: Simple Link

**HTML:**
```html
<p>Click <a href="/next">here</a> to continue</p>
```

### Step 1 — Parse to Graph

```
              p
              │
    ┌─────────┼─────────┐
    │0        │1        │2
    ▼         ▼         ▼
 "Click "     a    " to continue"
              │
              │0
              ▼
           "here"
```

Edge numbers encode content order:
- Position **0**: `"Click "`
- Position **1**: `<a>` element containing `"here"`
- Position **2**: `" to continue"`

### Step 2 — Add Shortcut Edge

```
              p
              │
    ┌─────────┼─────────┬─────────┐
    │0        │1        │2        │1
    ▼         ▼         ▼         ▼
 "Click "     a    " to continue" "here"
              │                     ▲
              │0                    │
              └─────────────────────┘
```

New edge `p→"here"` inherits position **1** from `p→a`.

### Step 3 — Remove Link Wrapper

```
              p
              │
    ┌─────────┼─────────┐
    │0        │1        │2
    ▼         ▼         ▼
 "Click "   "here"  " to continue"
```

### Step 4 — Merge Text Children

| Position | Text |
|----------|------|
| 0 | "Click " |
| 1 | "here" |
| 2 | " to continue" |

```
         p
         │
         │ 0
         ▼
"Click here to continue"
```

**Done.** Link tag removed, readable sentence preserved.

---

## Example 2: Bold Emphasis

**HTML:**
```html
<p>This is <b>very important</b> information</p>
```

### Step 1 — Parse to Graph

```
                  p
                  │
      ┌───────────┼───────────┐
      │0          │1          │2
      ▼           ▼           ▼
 "This is "       b      " information"
                  │
                  │0
                  ▼
          "very important"
```

### Step 2 — Add Shortcut Edge

```
                  p
                  │
      ┌───────────┼───────────┬───────────┐
      │0          │1          │2          │1
      ▼           ▼           ▼           ▼
 "This is "       b      " information"  "very important"
```

### Step 3 — Remove Bold Wrapper

```
                  p
                  │
      ┌───────────┼───────────┐
      │0          │1          │2
      ▼           ▼           ▼
 "This is "  "very important"  " information"
```

### Step 4 — Merge

| Position | Text |
|----------|------|
| 0 | "This is " |
| 1 | "very important" |
| 2 | " information" |

```
              p
              │
              │ 0
              ▼
"This is very important information"
```

---

## Example 3: Mixed Formatting

**HTML:**
```html
<p>Please <a href="/docs">read the docs</a> for <i>more details</i> here</p>
```

### Step 1 — Parse

```
                       p
                       │
      ┌────────┬───────┼───────┬────────┐
      │0       │1      │2      │3       │4
      ▼        ▼       ▼       ▼        ▼
 "Please "     a    " for "    i     " here"
               │               │
               │0              │0
               ▼               ▼
       "read the docs"   "more details"
```

Five children of `p`:
- Position 0: `"Please "`
- Position 1: `<a>` → `"read the docs"`
- Position 2: `" for "`
- Position 3: `<i>` → `"more details"`
- Position 4: `" here"`

### Step 2 — Add Shortcuts

```
                       p
                       │
      ┌────────┬───────┼───────┬────────┬───────┬───────┐
      │0       │1      │2      │3       │4      │1      │3
      ▼        ▼       ▼       ▼        ▼       ▼       ▼
 "Please "     a    " for "    i     " here"   ...     ...
                                           "read the   "more
                                             docs"    details"
```

Two new edges:
- `p→"read the docs"` with position **1**
- `p→"more details"` with position **3**

### Step 3 — Remove Wrappers

```
                       p
                       │
      ┌────────┬───────┼───────┬────────┐
      │0       │1      │2      │3       │4
      ▼        ▼       ▼       ▼        ▼
 "Please " "read the  " for " "more   " here"
            docs"             details"
```

### Step 4 — Merge

| Position | Text |
|----------|------|
| 0 | "Please " |
| 1 | "read the docs" |
| 2 | " for " |
| 3 | "more details" |
| 4 | " here" |

```
                    p
                    │
                    │ 0
                    ▼
"Please read the docs for more details here"
```

---

## Example 4: Nested Structure with Multiple Containers

**HTML:**
```html
<div>
    <p>Welcome to <b>our site</b> today</p>
    <p>Click <a href="/start">get started</a> now</p>
</div>
```

### Step 1 — Parse

```
                         div
                          │
            ┌─────────────┴─────────────┐
            │0                          │1
            ▼                           ▼
           p[0]                        p[1]
            │                           │
    ┌───────┼───────┐           ┌───────┼───────┐
    │0      │1      │2          │0      │1      │2
    ▼       ▼       ▼           ▼       ▼       ▼
"Welcome    b    " today"    "Click "   a     " now"
  to "      │                           │
            │0                          │0
            ▼                           ▼
       "our site"               "get started"
```

### Step 2 & 3 — Add Shortcuts, Remove Wrappers

```
                         div
                          │
            ┌─────────────┴─────────────┐
            │0                          │1
            ▼                           ▼
           p[0]                        p[1]
            │                           │
    ┌───────┼───────┐           ┌───────┼───────┐
    │0      │1      │2          │0      │1      │2
    ▼       ▼       ▼           ▼       ▼       ▼
"Welcome "our    " today"    "Click " "get    " now"
  to "   site"                       started"
```

### Step 4 — Merge (per container)

Each `<p>` merges its own children:

```
                         div
                          │
            ┌─────────────┴─────────────┐
            │0                          │1
            ▼                           ▼
           p[0]                        p[1]
            │                           │
            │0                          │0
            ▼                           ▼
"Welcome to our site today"    "Click get started now"
```

**Note:** Each paragraph becomes its own merged text. The `div` structure is preserved because it has multiple children (two `<p>` elements).

---

## Example 5: Deeply Nested Formatting

**HTML:**
```html
<p>This has <b><i>bold italic</i></b> text</p>
```

### Step 1 — Parse

```
           p
           │
    ┌──────┼──────┐
    │0     │1     │2
    ▼      ▼      ▼
"This has" b    " text"
           │
           │0
           ▼
           i
           │
           │0
           ▼
     "bold italic"
```

### Step 2 — First Collapse (i → text)

Since `<i>` has one child, add shortcut from `<b>` to text:

```
           p
           │
    ┌──────┼──────┐
    │0     │1     │2
    ▼      ▼      ▼
"This has" b    " text"
           │
           │0
           ▼
     "bold italic"
```

After removing `<i>`:

```
           p
           │
    ┌──────┼──────┐
    │0     │1     │2
    ▼      ▼      ▼
"This has" b    " text"
           │
           │0
           ▼
     "bold italic"
```

### Step 3 — Second Collapse (b → text)

Now `<b>` has one child, add shortcut from `<p>` to text:

```
           p
           │
    ┌──────┼──────┐
    │0     │1     │2
    ▼      ▼      ▼
"This has" "bold  " text"
            italic"
```

### Step 4 — Merge

| Position | Text |
|----------|------|
| 0 | "This has " |
| 1 | "bold italic" |
| 2 | " text" |

```
            p
            │
            │ 0
            ▼
"This has bold italic text"
```

**Note:** Deeply nested formatting collapses iteratively. Each pass removes one layer until all single-child wrappers are gone.

---

## Transformation Pipeline Summary

```
┌─────────────────────────────────────────────────────────────────┐
│                     TRANSFORMATION PIPELINE                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Step 1: Parse HTML to Graph                                     │
│          ─────────────────────                                   │
│          HTML elements → Nodes                                   │
│          Parent/child  → Edges with position numbers             │
│                                                                  │
│                            ▼                                     │
│                                                                  │
│  Step 2: Add Shortcut Edges                                      │
│          ────────────────────                                    │
│          For single-child parents:                               │
│          Create grandparent → text edge                          │
│          Inherit parent's position number                        │
│                                                                  │
│                            ▼                                     │
│                                                                  │
│  Step 3: Delete Single-Child Parents                             │
│          ───────────────────────────                             │
│          Remove formatting tags (a, b, i, etc.)                  │
│          Text nodes now direct children of container             │
│                                                                  │
│                            ▼                                     │
│                                                                  │
│  Step 4: Create Merged Text                                      │
│          ─────────────────────                                   │
│          Sort text children by position                          │
│          Concatenate in order                                    │
│          Create new merged text node                             │
│                                                                  │
│                            ▼                                     │
│                                                                  │
│  Step 5: Clean Up                                                │
│          ────────                                                │
│          Delete original text nodes                              │
│          Result: one text node per container                     │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Before & After Examples

### Link Removal
```
BEFORE                              AFTER
──────                              ─────

        p                                  p
        │                                  │
   ┌────┼────┐                             │ 0
   │0   │1   │2                            ▼
   ▼    ▼    ▼                  "Click here to continue"
"Click" a  " to
        │   continue"
        │0
        ▼
     "here"
```

### Bold Emphasis
```
BEFORE                              AFTER
──────                              ─────

          p                                p
          │                                │
   ┌──────┼──────┐                         │ 0
   │0     │1     │2                        ▼
   ▼      ▼      ▼          "This is very important information"
"This is" b   " information"
          │
          │0
          ▼
   "very important"
```

---

## Key Design Decisions

### Why preserve edge position numbers?

HTML content order is implicit in the DOM structure. When we flatten the tree, we lose that structural ordering. By encoding position in edge metadata, we can reconstruct the correct reading order even after removing intermediate nodes.

### Why collapse single-child parents only?

| Node Type | Children | Action |
|-----------|----------|--------|
| `<div>` with multiple `<p>` | Multiple | **Keep** — structural container |
| `<b>` with just `"important"` | Single | **Collapse** — pure formatting wrapper |
| `<a>` with just `"click here"` | Single | **Collapse** — simple wrapper |
| `<ul>` with `<li>` items | Multiple | **Keep** — structural container |

Elements with multiple children are structural containers. Elements with exactly one child are purely formatting wrappers. Collapsing only single-child parents preserves document structure while removing formatting noise.

### Why create merged nodes before deleting originals?

This ensures we can always read the text values during concatenation. If we deleted first, we'd lose the data needed to build the merged string.

### Why use edge position instead of node order?

Nodes in a graph have no inherent order. By storing position on edges, we make ordering explicit and queryable. This also allows multiple edges to share the same logical position during the transition (Step 2), which resolves cleanly after deletion (Step 3).

---

## Key Rules

| Rule | Why |
|------|-----|
| Only collapse **single-child** parents | Multi-child nodes are structural, not just formatting |
| Inherit **edge position** when creating shortcuts | Preserves reading order |
| Sort by position **before** merging | Ensures correct text sequence |
| Delete originals **after** creating merged node | Don't lose data mid-transform |
| Use `set()` when batch deleting | Avoid duplicate deletion attempts |
| Process **iteratively** for deep nesting | Each pass removes one layer of wrappers |

---

## Applications

This transformation pattern can be extended for:

- **Markdown extraction** — Preserve heading structure, flatten inline formatting
- **Search indexing** — Extract searchable text per semantic block
- **Content comparison** — Compare documents by their text content, ignoring formatting
- **Accessibility** — Generate plain-text versions of rich HTML
- **LLM preprocessing** — Simplify HTML to clean text for language model input
- **Web scraping** — Extract article text without boilerplate formatting
- **Diff generation** — Compare page versions by semantic content, not markup
- **Email processing** — Extract readable text from HTML emails

---

## Edge Cases

| Scenario | Behavior |
|----------|----------|
| Empty formatting tag `<b></b>` | No text child to shortcut; tag removed, nothing added |
| Nested formatting `<b><i>text</i></b>` | Collapse iteratively: removes `<i>` first, then `<b>` |
| Whitespace-only text nodes | Included in merge; trim separately if needed |
| Link with no text `<a href="x"></a>` | Removed as empty single-child wrapper |
| Multiple text nodes, same position | Shouldn't happen; indicates malformed source |
| No text children | Nothing to merge; container kept as-is |
| Very deep nesting `<b><i><u><s>text</s></u></i></b>` | Multiple iterations until flat |