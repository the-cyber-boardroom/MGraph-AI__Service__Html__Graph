# HTML Graph Node Flatten Transformation (Implementation Debrief)

## Overview

This document describes a graph-based transformation pipeline that converts HTML documents into simplified, flattened text representations while preserving content order. The workflow uses MGraph-DB to represent HTML as a property graph, then applies a series of transformations to collapse formatting elements and merge text content.

## Business Value

This transformation is useful for:

- **Text extraction** — Strip formatting tags while preserving readable content
- **Content indexing** — Create searchable text from HTML documents
- **Semantic analysis** — Reduce HTML to its essential text structure
- **Data normalization** — Standardize varied HTML structures into uniform representations

---

## Example 1: Simple Wrapper

**HTML:**
```html
<div><b>hello</b></div>
```

### Step 1 — Parse to Graph

```
    div
     │
     │ 0
     ▼
     b
     │
     │ 0
     ▼
  "hello"
```

The HTML is converted to a property graph where:
- **Nodes** represent elements (`div`, `b`) and text content (`"hello"`)
- **Edges** represent parent-child relationships
- **Edge numbers** indicate position within parent (content order)

### Step 2 — Add Shortcut Edge

```
    div
     │╲
     │ ╲ 0
     │0 ╲
     ▼   ▼
     b → "hello"
     │     ▲
     │ 0   │
     └─────┘
```

For single-child parents, we create a direct edge from grandparent to text node.

> **Key:** The new edge inherits position **0** from `div→b`. This preserves reading order.

### Step 3 — Remove Single-Child Parent

```
    div
     │
     │ 0
     ▼
  "hello"
```

Delete the `<b>` wrapper. The shortcut edge remains, maintaining the connection.

**Done.** One text node, correct order.

---

## Example 2: Mixed Content

**HTML:**
```html
<div>aa <b>bb</b> cc</div>
```

### Step 1 — Parse to Graph

```
         div
          │
    ┌─────┼─────┐
    │0    │1    │2
    ▼     ▼     ▼
  "aa"    b   "cc"
          │
          │0
          ▼
        "bb"
```

Edge numbers encode content order:
- Position **0**: `"aa"` (first text)
- Position **1**: `<b>` element (second item)
- Position **2**: `"cc"` (third text)

### Step 2 — Add Shortcut Edge

```
         div
          │
    ┌─────┼─────┬─────┐
    │0    │1    │2    │1
    ▼     ▼     ▼     ▼
  "aa"    b   "cc"  "bb"
          │           ▲
          │0          │
          └───────────┘
```

New edge `div→"bb"` gets position **1** (inherited from `div→b`).

Now we have two edges with position 1 — the original `div→b` and the new `div→"bb"`. This is intentional: they represent the same logical position in the content sequence.

### Step 3 — Remove `b`

```
         div
          │
    ┌─────┼─────┐
    │0    │1    │2
    ▼     ▼     ▼
  "aa"  "bb"  "cc"
```

All text nodes are now direct children of `div` with correct position numbers.

### Step 4 — Merge Text Children

Sort by position, then concatenate:

| Position | Text |
|----------|------|
| 0 | "aa" |
| 1 | "bb" |
| 2 | "cc" |

**Result:** `"aa bb cc"`

```
    div
     │
     │ 0
     ▼
  "aa bb cc"
```

### Step 5 — Clean Up

Delete original text nodes. Final state:

```
    div
     │
     │ 0
     ▼
  "aa bb cc"
```

**Done.** Formatting removed, text merged in reading order.

---

## Example 3: Multiple Formatting Tags

**HTML:**
```html
<div>A <b>B</b> C <i>D</i> E</div>
```

### Step 1 — Parse

```
              div
               │
    ┌────┬─────┼─────┬────┐
    │0   │1    │2    │3   │4
    ▼    ▼     ▼     ▼    ▼
   "A"   b    "C"    i   "E"
         │          │
         │0         │0
         ▼          ▼
        "B"        "D"
```

Five children of `div`:
- Position 0: `"A"`
- Position 1: `<b>` → `"B"`
- Position 2: `"C"`
- Position 3: `<i>` → `"D"`
- Position 4: `"E"`

### Step 2 — Add Shortcuts

```
              div
               │
    ┌────┬─────┼─────┬────┬────┬────┐
    │0   │1    │2    │3   │4   │1   │3
    ▼    ▼     ▼     ▼    ▼    ▼    ▼
   "A"   b    "C"    i   "E"  "B"  "D"
```

Two new edges:
- `div→"B"` with position **1** (from `div→b`)
- `div→"D"` with position **3** (from `div→i`)

### Step 3 — Remove Wrappers

```
              div
               │
    ┌────┬─────┼─────┬────┐
    │0   │1    │2    │3   │4
    ▼    ▼     ▼     ▼    ▼
   "A"  "B"   "C"   "D"  "E"
```

Both `<b>` and `<i>` removed. All text now direct children of `div`.

### Step 4 — Merge

| Position | Text |
|----------|------|
| 0 | "A" |
| 1 | "B" |
| 2 | "C" |
| 3 | "D" |
| 4 | "E" |

```
    div
     │
     │ 0
     ▼
 "A B C D E"
```

---

## Transformation Pipeline Summary

```
┌─────────────────────────────────────────────────────────────────┐
│                     TRANSFORMATION PIPELINE                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Step 1: Parse HTML to Graph                                     │
│          ─────────────────────                                   │
│          HTML elements → Nodes                                   │
│          Parent/child  → Edges with position numbers             │
│                                                                  │
│                            ▼                                     │
│                                                                  │
│  Step 2: Add Shortcut Edges                                      │
│          ────────────────────                                    │
│          For single-child parents:                               │
│          Create grandparent → text edge                          │
│          Inherit parent's position number                        │
│                                                                  │
│                            ▼                                     │
│                                                                  │
│  Step 3: Delete Single-Child Parents                             │
│          ───────────────────────────                             │
│          Remove formatting tags (a, b, i, etc.)                  │
│          Text nodes now direct children of container             │
│                                                                  │
│                            ▼                                     │
│                                                                  │
│  Step 4: Create Merged Text                                      │
│          ─────────────────────                                   │
│          Sort text children by position                          │
│          Concatenate in order                                    │
│          Create new merged text node                             │
│                                                                  │
│                            ▼                                     │
│                                                                  │
│  Step 5: Clean Up                                                │
│          ────────                                                │
│          Delete original text nodes                              │
│          Result: one text node per container                     │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Before & After

```
BEFORE                              AFTER
──────                              ─────

         div                           div
          │                             │
    ┌─────┼─────┐                       │ 0
    │0    │1    │2                      ▼
    ▼     ▼     ▼                  "aa bb cc"
  "aa"    b   "cc"
          │
          │0
          ▼
        "bb"
```

---

## Key Design Decisions

### Why preserve edge position numbers?

HTML content order is implicit in the DOM structure. When we flatten the tree, we lose that structural ordering. By encoding position in edge metadata, we can reconstruct the correct reading order even after removing intermediate nodes.

### Why collapse single-child parents only?

| Node Type | Children | Action |
|-----------|----------|--------|
| `<div>` with text + elements | Multiple | **Keep** — structural container |
| `<b>` with just `"bold"` | Single | **Collapse** — pure formatting wrapper |
| `<p>` with just `"text"` | Single | **Collapse** — simple wrapper |
| `<ul>` with `<li>` items | Multiple | **Keep** — structural container |

Elements with multiple children are structural containers. Elements with exactly one child are purely formatting wrappers. Collapsing only single-child parents preserves document structure while removing formatting noise.

### Why create merged nodes before deleting originals?

This ensures we can always read the text values during concatenation. If we deleted first, we'd lose the data needed to build the merged string.

### Why use edge position instead of node order?

Nodes in a graph have no inherent order. By storing position on edges, we make ordering explicit and queryable. This also allows multiple edges to share the same logical position during the transition (Step 2), which resolves cleanly after deletion (Step 3).

---

## Key Rules

| Rule | Why |
|------|-----|
| Only collapse **single-child** parents | Multi-child nodes are structural, not just formatting |
| Inherit **edge position** when creating shortcuts | Preserves reading order |
| Sort by position **before** merging | Ensures correct text sequence |
| Delete originals **after** creating merged node | Don't lose data mid-transform |
| Use `set()` when batch deleting | Avoid duplicate deletion attempts |

---

## Applications

This transformation pattern can be extended for:

- **Markdown extraction** — Preserve heading structure, flatten inline formatting
- **Search indexing** — Extract searchable text per semantic block
- **Content comparison** — Compare documents by their text content, ignoring formatting
- **Accessibility** — Generate plain-text versions of rich HTML
- **LLM preprocessing** — Simplify HTML to clean text for language model input
- **Web scraping** — Extract article text without boilerplate formatting
- **Diff generation** — Compare page versions by semantic content, not markup

---

## Edge Cases

| Scenario | Behavior |
|----------|----------|
| Empty formatting tag `<b></b>` | No text child to shortcut; tag removed, nothing added |
| Nested formatting `<b><i>text</i></b>` | Collapse iteratively: `b→i→text` becomes `parent→text` |
| Whitespace-only text nodes | Included in merge; trim separately if needed |
| Multiple text nodes, same position | Shouldn't happen; indicates malformed source |
| No text children | Nothing to merge; container kept as-is |