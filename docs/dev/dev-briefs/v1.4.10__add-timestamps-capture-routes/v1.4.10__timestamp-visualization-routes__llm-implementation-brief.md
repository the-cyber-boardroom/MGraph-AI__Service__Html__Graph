# Timestamp Visualization Routes - LLM Implementation Brief

**Version**: v1.4.10  
**Purpose**: Implementation guide for adding timestamp capture and export to web service routes  
**Location**: `mgraph_ai_service_html_graph.routes.Routes__Timestamps`  
**Dependencies**: `osbot_utils.helpers.timestamp_capture`

---

## Executive Summary

### Why

Production web services need observability into their execution patterns. When a transformation pipeline runs slowly or behaves unexpectedly, developers need to answer:

- **Where is time being spent?** Which methods are hotspots?
- **What is the call flow?** How do methods nest and sequence?
- **How does it compare?** Is this run slower than previous ones?

Traditional profiling requires attaching debuggers or modifying code. We want **non-invasive, on-demand profiling** that:

1. Can be enabled per-request via API
2. Returns structured, serializable data
3. Integrates with visualization tools (speedscope, flame graphs)
4. Works in distributed systems (capture here, visualize there)

### How

We leverage the existing `timestamp_capture` instrumentation system:

1. **Wrap execution** - Route handler creates a `Timestamp_Collector` context
2. **Capture automatically** - Methods decorated with `@timestamp` record enter/exit
3. **Export structured data** - Type_Safe schemas serialize the results
4. **Return alongside graph** - Response includes both graph output and traces

The key insight: **separation of concerns**. The transformation pipeline doesn't know it's being traced. The route handler orchestrates capture and export. The client chooses the export format.

### What

Three new routes that mirror existing graph routes but add timestamp capture:

```
POST /timestamps/graph/from/html/to/{engine}/{transformation}/full
POST /timestamps/graph/from/html/to/{engine}/{transformation}/summary  
POST /timestamps/graph/from/html/to/{engine}/{transformation}/speedscope
```

Each returns:
- The **graph output** (same as existing routes)
- The **execution traces** (in the requested format)

---

## Architecture

### System Context

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              CLIENT                                          │
│  (Browser, CLI, Other Service)                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      │ POST /timestamps/graph/from/html/to/dot/default/speedscope
                                      │ Body: { graph_request: {...}, trace_config: {...} }
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         ROUTES__TIMESTAMPS                                   │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │  1. Create Timestamp_Collector                                         │ │
│  │  2. Execute transformation pipeline (with collector in scope)          │ │
│  │  3. Export traces to requested format                                  │ │
│  │  4. Return graph + traces                                              │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      │ Response: { graph: {...}, traces: {...} }
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              CLIENT                                          │
│  - Display graph (DOT/VisJS/etc)                                            │
│  - Open traces in speedscope.app                                            │
│  - Store traces for comparison                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Internal Flow

```
┌──────────────────────────────────────────────────────────────────────────────────────┐
│                            Routes__Timestamps                                         │
│                                                                                       │
│   Request                                                                             │
│      │                                                                                │
│      ▼                                                                                │
│   ┌─────────────────────┐                                                            │
│   │ Create Collector    │  _timestamp_collector_ = Timestamp_Collector(name=...)     │
│   └─────────────────────┘                                                            │
│      │                                                                                │
│      ▼                                                                                │
│   ┌─────────────────────┐     ┌─────────────────────────────────────────────────┐   │
│   │ with collector:     │────▶│  Html_Graph__Export__Service                     │   │
│   │   execute pipeline  │     │                                                  │   │
│   └─────────────────────┘     │  @timestamp                                      │   │
│      │                        │  def to_dot(request, transformation):            │   │
│      │                        │      doc = self._create_document(html)  ◄────┐   │   │
│      │                        │      mgraph = self._transform(doc)           │   │   │
│      │                        │      return self._export(mgraph)             │   │   │
│      │                        │                                              │   │   │
│      │                        │  @timestamp  ◄───────────────────────────────┘   │   │
│      │                        │  def _create_document(html):                     │   │
│      │                        │      ...                                         │   │
│      │                        └─────────────────────────────────────────────────┘   │
│      │                                                                                │
│      ▼                                                                                │
│   ┌─────────────────────┐                                                            │
│   │ Export traces       │  export = Timestamp_Collector__Export(collector)           │
│   │ (format from route) │  traces = export.to_speedscope()  # or full/summary        │
│   └─────────────────────┘                                                            │
│      │                                                                                │
│      ▼                                                                                │
│   ┌─────────────────────┐                                                            │
│   │ Build response      │  Response(graph=graph_result, traces=traces)               │
│   └─────────────────────┘                                                            │
│      │                                                                                │
│      ▼                                                                                │
│   Response                                                                            │
│                                                                                       │
└──────────────────────────────────────────────────────────────────────────────────────┘
```

### Trace Data Flow

```
                    CAPTURE                      EXPORT                    VISUALIZE
                       │                            │                           │
                       ▼                            ▼                           ▼
┌──────────────────────────────┐  ┌──────────────────────────┐  ┌─────────────────────────┐
│    @timestamp decorators     │  │  Timestamp_Collector     │  │   External Tools        │
│                              │  │  __Export                │  │                         │
│  ┌────────────────────────┐  │  │                          │  │  ┌───────────────────┐  │
│  │ method_a()             │  │  │  .to_export_full()       │──┼─▶│ JSON analysis     │  │
│  │   ├─▶ enter @ 0.0ms    │  │  │       │                  │  │  └───────────────────┘  │
│  │   │                    │  │  │       ▼                  │  │                         │
│  │   │  method_b()        │  │  │  Schema__Export_Full     │  │  ┌───────────────────┐  │
│  │   │    ├─▶ enter       │  │  │                          │  │  │ Compare runs      │  │
│  │   │    └─◀ exit        │  │  │  .to_export_summary()    │──┼─▶│ Store history     │  │
│  │   │                    │  │  │       │                  │  │  └───────────────────┘  │
│  │   │  method_c()        │  │  │       ▼                  │  │                         │
│  │   │    ├─▶ enter       │  │  │  Schema__Export_Summary  │  │  ┌───────────────────┐  │
│  │   │    └─◀ exit        │  │  │                          │  │  │ speedscope.app    │  │
│  │   │                    │  │  │  .to_speedscope()        │──┼─▶│ Flame graphs      │  │
│  │   └─◀ exit @ 50.0ms    │  │  │       │                  │  │  │ Interactive       │  │
│  └────────────────────────┘  │  │       ▼                  │  │  └───────────────────┘  │
│                              │  │  Schema__Speedscope      │  │                         │
│  Entries: [e1, e2, e3, ...]  │  │                          │  │                         │
└──────────────────────────────┘  └──────────────────────────┘  └─────────────────────────┘
```

---

## Route Specifications

### Routes Overview

| Route | Response Type | Use Case |
|-------|---------------|----------|
| `POST .../full` | `Schema__Graph__With_Traces__Response__Full` | Complete data for storage/analysis |
| `POST .../summary` | `Schema__Graph__With_Traces__Response__Summary` | Quick hotspot overview |
| `POST .../speedscope` | `Schema__Graph__With_Traces__Response__Speedscope` | Interactive visualization |

### URL Pattern

```
/timestamps/graph/from/html/to/{engine}/{transformation}/{format}
                          │         │              │           │
                          │         │              │           └── full | summary | speedscope
                          │         │              │
                          │         │              └── Transformation name (e.g., "default")
                          │         │
                          │         └── Render engine (dot, visjs, d3, cytoscape, mermaid, tree)
                          │
                          └── Source type (html for now, url later)
```

### Request/Response Examples

**Request:**
```json
{
  "graph_request": {
    "html": "<html><head><title>Test</title></head><body><p>Hello</p></body></html>",
    "transformation": "default"
  },
  "trace_config": {
    "output": "response_only"
  }
}
```

**Response (speedscope format):**
```json
{
  "graph": {
    "duration": 0.045,
    "transformation": "default",
    "engine": "dot",
    "node_count": 12,
    "edge_count": 11,
    "dot": "digraph { ... }",
    "dot_size": 1234
  },
  "traces": {
    "$schema": "https://www.speedscope.app/file-format-schema.json",
    "shared": {
      "frames": [
        {"name": "to_dot"},
        {"name": "_create_document"},
        {"name": "_transform"}
      ]
    },
    "profiles": [{
      "type": "evented",
      "name": "default.dot",
      "unit": "microseconds",
      "events": [
        {"type": "O", "frame": 0, "at": 0},
        {"type": "O", "frame": 1, "at": 100},
        {"type": "C", "frame": 1, "at": 15000},
        ...
      ]
    }],
    "name": "default.dot"
  }
}
```

---

## Schema Definitions

### Enums

```python
# Location: schemas/routes/enums/Enum__Trace_Format.py

from enum import Enum

class Enum__Trace_Format(str, Enum):
    full       = 'full'        # Complete export with all data
    summary    = 'summary'     # Compact hotspot overview
    speedscope = 'speedscope'  # speedscope.app compatible format
```

```python
# Location: schemas/routes/enums/Enum__Trace_Output.py

from enum import Enum

class Enum__Trace_Output(str, Enum):
    response_only = 'response_only'  # Include traces in response only
    external_only = 'external_only'  # Send to external service only (future)
    both          = 'both'           # Both response and external (future)
```

### Config Schema

```python
# Location: schemas/routes/Schema__Trace_Config.py

from osbot_utils.type_safe.Type_Safe                          import Type_Safe
from .enums.Enum__Trace_Output                                import Enum__Trace_Output

class Schema__Trace_Config(Type_Safe):
    output : Enum__Trace_Output = Enum__Trace_Output.response_only
```

### Request Schema

```python
# Location: schemas/routes/Schema__Graph__With_Traces__Request.py

from osbot_utils.type_safe.Type_Safe                          import Type_Safe
from .Schema__Graph__From_Html__Request                       import Schema__Graph__From_Html__Request
from .Schema__Trace_Config                                    import Schema__Trace_Config

class Schema__Graph__With_Traces__Request(Type_Safe):
    graph_request : Schema__Graph__From_Html__Request
    trace_config  : Schema__Trace_Config
```

### Response Schemas

```python
# Location: schemas/routes/Schema__Graph__With_Traces__Response__Full.py

from osbot_utils.type_safe.Type_Safe                                    import Type_Safe
from osbot_utils.helpers.timestamp_capture.schemas.export               import Schema__Export_Full
from mgraph_ai_service_html_graph.schemas.routes                        import Schema__Graph__Response__Base

class Schema__Graph__With_Traces__Response__Full(Type_Safe):
    graph  : Schema__Graph__Response__Base
    traces : Schema__Export_Full
```

```python
# Location: schemas/routes/Schema__Graph__With_Traces__Response__Summary.py

from osbot_utils.type_safe.Type_Safe                                    import Type_Safe
from osbot_utils.helpers.timestamp_capture.schemas.export               import Schema__Export_Summary
from mgraph_ai_service_html_graph.schemas.routes                        import Schema__Graph__Response__Base

class Schema__Graph__With_Traces__Response__Summary(Type_Safe):
    graph  : Schema__Graph__Response__Base
    traces : Schema__Export_Summary
```

```python
# Location: schemas/routes/Schema__Graph__With_Traces__Response__Speedscope.py

from osbot_utils.type_safe.Type_Safe                                    import Type_Safe
from osbot_utils.helpers.timestamp_capture.schemas.speedscope           import Schema__Speedscope
from mgraph_ai_service_html_graph.schemas.routes                        import Schema__Graph__Response__Base

class Schema__Graph__With_Traces__Response__Speedscope(Type_Safe):
    graph  : Schema__Graph__Response__Base
    traces : Schema__Speedscope
```

---

## Route Implementation

### Routes Class

```python
# Location: routes/Routes__Timestamps.py

from osbot_fast_api.api.decorators.route_path                           import route_path
from osbot_fast_api.api.routes.Fast_API__Routes                         import Fast_API__Routes
from osbot_utils.helpers.timestamp_capture.Timestamp_Collector          import Timestamp_Collector
from osbot_utils.helpers.timestamp_capture.Timestamp_Collector__Export  import Timestamp_Collector__Export

# Import schemas...

TAG__ROUTES_TIMESTAMPS = 'timestamps'

ROUTES_PATHS__TIMESTAMPS = [
    f'/{TAG__ROUTES_TIMESTAMPS}/graph/from/html/to/{{engine}}/{{transformation}}/full',
    f'/{TAG__ROUTES_TIMESTAMPS}/graph/from/html/to/{{engine}}/{{transformation}}/summary',
    f'/{TAG__ROUTES_TIMESTAMPS}/graph/from/html/to/{{engine}}/{{transformation}}/speedscope',
]

class Routes__Timestamps(Fast_API__Routes):
    tag           : str                        = TAG__ROUTES_TIMESTAMPS
    graph_service : Html_Graph__Export__Service

    # ═══════════════════════════════════════════════════════════════════════════
    # Route Handlers
    # ═══════════════════════════════════════════════════════════════════════════

    @route_path("/graph/from/html/to/{engine}/{transformation}/full")
    def from_html_with_traces_full(self, engine        : str,
                                         transformation: str,
                                         request       : Schema__Graph__With_Traces__Request
                                  ) -> Schema__Graph__With_Traces__Response__Full:
        graph_response = self._execute_with_timestamps(engine, transformation, request)
        traces         = self._export.to_export_full()
        return Schema__Graph__With_Traces__Response__Full(graph=graph_response, traces=traces)

    @route_path("/graph/from/html/to/{engine}/{transformation}/summary")
    def from_html_with_traces_summary(self, engine        : str,
                                            transformation: str,
                                            request       : Schema__Graph__With_Traces__Request
                                     ) -> Schema__Graph__With_Traces__Response__Summary:
        graph_response = self._execute_with_timestamps(engine, transformation, request)
        traces         = self._export.to_export_summary()
        return Schema__Graph__With_Traces__Response__Summary(graph=graph_response, traces=traces)

    @route_path("/graph/from/html/to/{engine}/{transformation}/speedscope")
    def from_html_with_traces_speedscope(self, engine        : str,
                                               transformation: str,
                                               request       : Schema__Graph__With_Traces__Request
                                        ) -> Schema__Graph__With_Traces__Response__Speedscope:
        graph_response = self._execute_with_timestamps(engine, transformation, request)
        traces         = self._export.to_speedscope()
        return Schema__Graph__With_Traces__Response__Speedscope(graph=graph_response, traces=traces)

    # ═══════════════════════════════════════════════════════════════════════════
    # Internal Methods
    # ═══════════════════════════════════════════════════════════════════════════

    def _execute_with_timestamps(self, engine        : str,
                                       transformation: str,
                                       request       : Schema__Graph__With_Traces__Request
                                ) -> Schema__Graph__Response__Base:
        collector_name         = f"{transformation}.{engine}"
        _timestamp_collector_  = Timestamp_Collector(name=collector_name)

        with _timestamp_collector_:
            graph_response = self._execute_pipeline(engine, transformation, request.graph_request)

        self._export = Timestamp_Collector__Export(collector=_timestamp_collector_)
        return graph_response

    def _execute_pipeline(self, engine       : str,
                                transformation: str,
                                request       : Schema__Graph__From_Html__Request
                         ) -> Schema__Graph__Response__Base:
        render_method = self._get_render_method(engine)
        return render_method(request, transformation=transformation)

    def _get_render_method(self, engine: str):
        engine_methods = {
            'default'  : self.graph_service.to_dot,
            'dot'      : self.graph_service.to_dot,
            'visjs'    : self.graph_service.to_visjs,
            'd3'       : self.graph_service.to_d3,
            'cytoscape': self.graph_service.to_cytoscape,
            'mermaid'  : self.graph_service.to_mermaid,
            'tree'     : self.graph_service.to_tree,
        }
        if engine not in engine_methods:
            raise ValueError(f"Unknown graph engine: {engine}")
        return engine_methods[engine]

    # ═══════════════════════════════════════════════════════════════════════════
    # Route Setup
    # ═══════════════════════════════════════════════════════════════════════════

    def setup_routes(self):
        self.add_route_post(self.from_html_with_traces_full)
        self.add_route_post(self.from_html_with_traces_summary)
        self.add_route_post(self.from_html_with_traces_speedscope)
        return self
```

---

## Usage Examples

### Python Client

```python
import requests

# Request with trace capture
response = requests.post(
    "http://localhost:8000/timestamps/graph/from/html/to/dot/default/speedscope",
    json={
        "graph_request": {
            "html": "<html><body><p>Hello World</p></body></html>",
            "transformation": "default"
        },
        "trace_config": {
            "output": "response_only"
        }
    }
)

data = response.json()

# Use the graph
print(data['graph']['dot'])

# Save speedscope for visualization
with open('profile.speedscope.json', 'w') as f:
    import json
    json.dump(data['traces'], f)

# Open in browser: https://speedscope.app (drag & drop the file)
```

### cURL

```bash
curl -X POST "http://localhost:8000/timestamps/graph/from/html/to/dot/default/summary" \
  -H "Content-Type: application/json" \
  -d '{
    "graph_request": {
      "html": "<html><body><p>Test</p></body></html>",
      "transformation": "default"
    },
    "trace_config": {
      "output": "response_only"
    }
  }'
```

---

## Future Extensions

### Phase 2: External Storage

```python
class Enum__Trace_Output(str, Enum):
    response_only = 'response_only'
    external_only = 'external_only'  # ◄── Enable this
    both          = 'both'           # ◄── Enable this

# In route handler:
if request.trace_config.output in [Enum__Trace_Output.external_only, Enum__Trace_Output.both]:
    self.trace_storage.store(traces)

if request.trace_config.output in [Enum__Trace_Output.response_only, Enum__Trace_Output.both]:
    response.traces = traces
```

### Phase 3: URL Source

```
POST /timestamps/graph/from/url/to/{engine}/{transformation}/{format}
```

### Phase 4: Trace Comparison

```
POST /timestamps/compare
Body: { trace_a: Schema__Export_Full, trace_b: Schema__Export_Full }
Response: { diff: Schema__Trace_Diff }
```

### Phase 5: LLM Analysis

```
POST /timestamps/analyze
Body: { traces: Schema__Export_Full }
Response: { insights: [...], recommendations: [...] }
```

---

## File Structure

```
mgraph_ai_service_html_graph/
├── routes/
│   ├── Routes__Graph.py                    # Existing graph routes
│   └── Routes__Timestamps.py               # NEW - Timestamp routes
│
├── schemas/
│   └── routes/
│       ├── enums/
│       │   ├── Enum__Trace_Format.py       # NEW
│       │   └── Enum__Trace_Output.py       # NEW
│       │
│       ├── Schema__Trace_Config.py                           # NEW
│       ├── Schema__Graph__With_Traces__Request.py            # NEW
│       ├── Schema__Graph__With_Traces__Response__Full.py     # NEW
│       ├── Schema__Graph__With_Traces__Response__Summary.py  # NEW
│       └── Schema__Graph__With_Traces__Response__Speedscope.py # NEW
│
└── service/
    └── html_graph__export/
        └── Html_Graph__Export__Service.py  # Existing (needs @timestamp decorators)
```

---

## Implementation Checklist

- [ ] Create `Enum__Trace_Format`
- [ ] Create `Enum__Trace_Output`
- [ ] Create `Schema__Trace_Config`
- [ ] Create `Schema__Graph__With_Traces__Request`
- [ ] Create `Schema__Graph__With_Traces__Response__Full`
- [ ] Create `Schema__Graph__With_Traces__Response__Summary`
- [ ] Create `Schema__Graph__With_Traces__Response__Speedscope`
- [ ] Create `Routes__Timestamps`
- [ ] Add `@timestamp` decorators to key service methods
- [ ] Register routes in FastAPI app
- [ ] Write integration tests
- [ ] Test with speedscope.app

---

## Dependencies

```python
# osbot_utils (existing)
from osbot_utils.helpers.timestamp_capture.Timestamp_Collector          import Timestamp_Collector
from osbot_utils.helpers.timestamp_capture.Timestamp_Collector__Export  import Timestamp_Collector__Export
from osbot_utils.helpers.timestamp_capture.schemas.export               import Schema__Export_Full
from osbot_utils.helpers.timestamp_capture.schemas.export               import Schema__Export_Summary
from osbot_utils.helpers.timestamp_capture.schemas.speedscope           import Schema__Speedscope

# osbot_fast_api (existing)
from osbot_fast_api.api.decorators.route_path                           import route_path
from osbot_fast_api.api.routes.Fast_API__Routes                         import Fast_API__Routes
```
