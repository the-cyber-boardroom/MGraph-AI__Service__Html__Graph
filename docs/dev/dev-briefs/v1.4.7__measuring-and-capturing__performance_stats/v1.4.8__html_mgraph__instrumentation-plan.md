# Html_MGraph & MGraph-DB Instrumentation Plan

**Version**: v1.4.7  
**Date**: December 2025  
**Purpose**: Add `@timestamp` decorators to capture performance metrics  
**Framework**: `osbot_utils.helpers.timestamp_capture` (v3.58.0+)  
**Repos**: MGraph-DB, MGraph-AI__Service__Html__Graph

---

## Table of Contents

1. [Overview](#overview)
2. [The @timestamp Framework](#the-timestamp-framework)
3. [Architecture](#architecture)
4. [Implementation Phases](#implementation-phases)
5. [Instrumentation Details](#instrumentation-details)
6. [Naming Convention](#naming-convention)
7. [Expected Output](#expected-output)
8. [Notes](#notes)

---

## Overview

This document describes the instrumentation strategy for capturing performance metrics across the Html_MGraph transformation pipeline using the `@timestamp` decorator system from OSBot-Utils.

### Goals

1. **Identify bottlenecks** in the HTML → MGraph conversion pipeline
2. **Measure self-time** to find actual hotspots (not just call trees)
3. **Track scalability** to detect O(n²) patterns
4. **Enable production monitoring** with minimal overhead (~3μs when inactive)
5. **Leave decorators in place** for ongoing performance visibility

### Current Performance Issue

```
Observed: 1,500ms to convert 400 bytes of HTML with attributes
Expected: <100ms for such a small document

Phase breakdown:
  HTML → Document : 1,376ms (92%)  ← Where is this time going?
  Document → HTML :   124ms ( 8%)
```

---

## The @timestamp Framework

### How It Works

The `@timestamp` decorator system uses **stack-walking** to find a collector, avoiding the need to pass timing context through every function signature.

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         STACK-WALKING MECHANISM                             │
└─────────────────────────────────────────────────────────────────────────────┘

  TEST CODE                                    SOURCE CODE
  ─────────                                    ───────────
  
  def test_conversion():                       class Converter:
      │                                            │
      │  # Create collector with                   │  @timestamp(name="convert")
      │  # magic variable name                     │  def convert(self, html):
      │                                            │      │
      ▼                                            │      │
  _timestamp_collector_ = Collector()              │      ▼
      │                                            │  # Decorator executes:
      │  with _timestamp_collector_:               │  # 1. Walk stack frames
      │      │                                     │  # 2. Look for '_timestamp_collector_'
      │      │                                     │  # 3. If found → record timing
      │      ▼                                     │  # 4. If not → execute normally
      │  result = converter.convert(html)  ───────┼──────►
      │      │                                     │
      │      │◄─────── returns ───────────────────┼───────
      │      │                                     │
      │  _timestamp_collector_.print_report()      │
      ▼                                            ▼


  CALL STACK (during convert execution):
  ┌────────────────────────────────────────────────────────────┐
  │  Frame 0: Converter.convert()          ◄── @timestamp here │
  │  Frame 1: ...                                              │
  │  Frame 2: ...                                              │
  │  Frame N: test_conversion()            ◄── collector here  │
  │           └─ _timestamp_collector_ = Collector()           │
  └────────────────────────────────────────────────────────────┘
                          │
                          │ stack walk finds collector
                          ▼
              ┌─────────────────────────┐
              │  collector.enter(name)  │
              │  ... execute method ... │
              │  collector.exit(name)   │
              └─────────────────────────┘
```

### Key Design Decisions

| Decision | Rationale |
|----------|-----------|
| **Magic variable name** `_timestamp_collector_` | Simple convention, explicit intent |
| **Stack-walking** | No signature changes needed in source code |
| **No-op when absent** | ~3μs overhead, safe for production |
| **perf_counter_ns** | Monotonic, high-resolution timing |
| **Self-time calculation** | Identifies actual bottlenecks |

### Framework Components

```
osbot_utils.helpers.timestamp_capture/
├── Timestamp_Collector.py           # Core collector class
├── Timestamp_Collector__Report.py   # Report generation
├── Timestamp_Collector__Analysis.py # Timing analysis
├── decorators/
│   └── timestamp.py                 # @timestamp decorator
└── context_managers/
    └── timestamp_block.py           # timestamp_block() for code sections
```

### Import Reference

```python
# Decorator (add to source files)
from osbot_utils.helpers.timestamp_capture.decorators.timestamp import timestamp

# Collector (add to test files)
from osbot_utils.helpers.timestamp_capture.Timestamp_Collector         import Timestamp_Collector
from osbot_utils.helpers.timestamp_capture.Timestamp_Collector__Report import Timestamp_Collector__Report

# Block timing (optional, for code sections)
from osbot_utils.helpers.timestamp_capture.context_managers.timestamp_block import timestamp_block
```

### Overhead Characteristics

| Scenario | Overhead | Use Case |
|----------|----------|----------|
| `@timestamp`, no collector in stack | ~3 μs | Production (decorators present, not profiling) |
| `@timestamp`, collector active | ~8 μs | Debugging/profiling sessions |
| N nested decorated methods | N × ~8 μs | Scales linearly |

**Rule**: If method takes >100μs, the 8μs overhead is <8% — acceptable for profiling.

---

## Architecture

### System Layers

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              TEST LAYER                                     │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  _timestamp_collector_ = Timestamp_Collector(name="perf_test")        │  │
│  │  with _timestamp_collector_:                                          │  │
│  │      doc = converter.convert(html)                                    │  │
│  │  _timestamp_collector_.print_report()                                 │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────┬──────────────────────────────────────────┘
                                   │ calls
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        HTML_MGRAPH SERVICE LAYER                            │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  @timestamp(name="html_mgraph.convert.to_document")                 │    │
│  │  def convert(self, html) -> Html_MGraph__Document:                  │    │
│  │      doc = Html_MGraph__Document().setup()                          │    │
│  │      self._build_body_graph(doc)                                    │    │
│  │      self._build_attrs_graph(doc)   ◄── SUSPECTED BOTTLENECK        │    │
│  │      return doc                                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  Subgraphs: body_graph, head_graph, attrs_graph, scripts_graph, styles_graph│
└──────────────────────────────────┬──────────────────────────────────────────┘
                                   │ calls
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           MGRAPH-DB LAYER                                   │
│  ┌────────────────────────┐  ┌────────────────────────┐                     │
│  │  MGraph__Edit          │  │  MGraph__Index         │                     │
│  │  ───────────────       │  │  ─────────────         │                     │
│  │  @timestamp            │  │  @timestamp            │                     │
│  │  def new_node()        │  │  def add_node()        │                     │
│  │  def new_edge()        │  │  def add_edge()        │                     │
│  │  def new_value()       │  │  def rebuild()         │                     │
│  └────────────────────────┘  └────────────────────────┘                     │
│                                                                             │
│  ┌────────────────────────┐  ┌────────────────────────┐                     │
│  │  MGraph__Index__Values │  │  Schema Classes        │                     │
│  │  ─────────────────────  │  │  ──────────────       │                     │
│  │  @timestamp            │  │  Type_Safe validation  │                     │
│  │  def get_or_create()   │  │  (not instrumented)    │                     │
│  │  def compute_hash()    │  │                        │                     │
│  └────────────────────────┘  └────────────────────────┘                     │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Data Flow with Timing Capture

```
                    ┌─────────────────────────────────────────┐
                    │         HTML INPUT STRING               │
                    │   "<html><body class='x'>...</body>"    │
                    └───────────────────┬─────────────────────┘
                                        │
                    ┌───────────────────▼─────────────────────┐
                    │  html_mgraph.convert.to_document        │ ──► TIMING START
                    └───────────────────┬─────────────────────┘
                                        │
          ┌─────────────────────────────┼─────────────────────────────┐
          │                             │                             │
          ▼                             ▼                             ▼
┌─────────────────────┐   ┌─────────────────────┐   ┌─────────────────────┐
│ html_mgraph.        │   │ html_mgraph.        │   │ html_mgraph.        │
│ document.setup      │   │ body.build          │   │ attrs.build         │
└─────────┬───────────┘   └─────────┬───────────┘   └─────────┬───────────┘
          │                         │                         │
          │                         ▼                         ▼
          │               ┌─────────────────────┐   ┌─────────────────────┐
          │               │ html_mgraph.body.   │   │ html_mgraph.attrs.  │
          │               │ process_element     │   │ set_attribute       │
          │               │ (called N times)    │   │ (called M times)    │
          │               └─────────┬───────────┘   └─────────┬───────────┘
          │                         │                         │
          └─────────────────────────┼─────────────────────────┘
                                    │
                    ┌───────────────▼─────────────────────────┐
                    │           MGRAPH-DB LAYER               │
                    │                                         │
                    │   ┌─────────────┐  ┌─────────────┐      │
                    │   │ mgraph.edit │  │ mgraph.     │      │
                    │   │ .new_node   │  │ index.      │      │
                    │   │ .new_edge   │  │ add_node    │      │
                    │   │ .new_value  │  │ add_edge    │      │
                    │   └─────────────┘  └─────────────┘      │
                    │                                         │
                    │   ┌─────────────────────────────┐       │
                    │   │ mgraph.index.values.        │       │
                    │   │ get_or_create               │       │
                    │   │ (uniqueness checking)       │       │
                    │   └─────────────────────────────┘       │
                    │                                         │
                    └───────────────────┬─────────────────────┘
                                        │
                    ┌───────────────────▼─────────────────────┐
                    │         Html_MGraph__Document           │ ──► TIMING END
                    └─────────────────────────────────────────┘
```

### Timing Capture Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         TIMING CAPTURE SEQUENCE                             │
└─────────────────────────────────────────────────────────────────────────────┘

Time ──────────────────────────────────────────────────────────────────────►

│ ▶ html_mgraph.convert.to_document ─────────────────────────────────────────┐
│   │                                                                        │
│   │ ▶ html_mgraph.document.setup ────────────────┐                         │
│   │ ◀ ───────────────────────────────────────────┘                         │
│   │                                                                        │
│   │ ▶ html_mgraph.body.build ────────────────────────────────────┐         │
│   │   │                                                          │         │
│   │   │ ▶ html_mgraph.body.process_element ──┐                   │         │
│   │   │   │                                  │                   │         │
│   │   │   │ ▶ mgraph.edit.new_node ─┐        │                   │         │
│   │   │   │ ◀ ──────────────────────┘        │                   │         │
│   │   │   │                                  │                   │         │
│   │   │   │ ▶ mgraph.index.add_node ┐        │                   │         │
│   │   │   │ ◀ ──────────────────────┘        │                   │         │
│   │   │ ◀ ───────────────────────────────────┘                   │         │
│   │   │                                                          │         │
│   │   │ ▶ html_mgraph.body.process_element ──┐  (repeat N times) │         │
│   │   │ ◀ ───────────────────────────────────┘                   │         │
│   │ ◀ ───────────────────────────────────────────────────────────┘         │
│   │                                                                        │
│   │ ▶ html_mgraph.attrs.build ───────────────────────────────────┐         │
│   │   │                                                          │         │
│   │   │ ▶ html_mgraph.attrs.set_attribute ───┐                   │         │
│   │   │   │                                  │                   │         │
│   │   │   │ ▶ mgraph.edit.new_value ────┐    │                   │         │
│   │   │   │   │                         │    │                   │         │
│   │   │   │   │ ▶ mgraph.index.values.  │    │                   │         │
│   │   │   │   │   get_or_create ──┐     │    │                   │         │
│   │   │   │   │ ◀ ────────────────┘     │    │                   │         │
│   │   │   │ ◀ ──────────────────────────┘    │                   │         │
│   │   │ ◀ ───────────────────────────────────┘                   │         │
│   │   │                                                          │         │
│   │   │ ▶ html_mgraph.attrs.set_attribute ───┐  (repeat M times) │         │
│   │   │ ◀ ───────────────────────────────────┘                   │         │
│   │ ◀ ───────────────────────────────────────────────────────────┘         │
│ ◀ ─────────────────────────────────────────────────────────────────────────┘

Legend: ▶ = enter, ◀ = exit
```

---

## Implementation Phases

### Phase 1: Investigation (Current)

**Goal**: Find the bottleneck causing 1,500ms conversion time

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  PHASE 1: COLLECTOR IN TESTS ONLY                                          │
└─────────────────────────────────────────────────────────────────────────────┘

  ┌─────────────────────────────────────┐
  │  tests/_performance/                │
  │  ─────────────────────              │
  │                                     │
  │  _timestamp_collector_ = ...        │  ◄── Collector lives HERE
  │  with _timestamp_collector_:        │
  │      converter.convert(html)        │
  │  print_report()                     │
  │                                     │
  └─────────────────────────────────────┘
                    │
                    │ calls (stack walk finds collector)
                    ▼
  ┌─────────────────────────────────────┐
  │  Html_MGraph Service                │
  │  ───────────────────                │
  │                                     │
  │  @timestamp(name="...")             │  ◄── Decorators in source
  │  def convert(self, html):           │
  │      ...                            │
  │                                     │
  └─────────────────────────────────────┘
                    │
                    ▼
  ┌─────────────────────────────────────┐
  │  MGraph-DB                          │
  │  ─────────                          │
  │                                     │
  │  @timestamp(name="...")             │  ◄── Decorators in source
  │  def new_node(self):                │
  │      ...                            │
  │                                     │
  └─────────────────────────────────────┘

  Advantages:
  ✓ No production impact
  ✓ Fine-grained instrumentation
  ✓ Easy to iterate
  ✓ Clear test isolation
```

### Phase 2: Optimization

**Goal**: Fix identified bottlenecks, validate improvements

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  PHASE 2: ITERATE ON FIXES                                                  │
└─────────────────────────────────────────────────────────────────────────────┘

  1. Run tests → Identify hotspots (self-time analysis)
  2. Implement fix (e.g., batch indexing, lazy evaluation)
  3. Re-run tests → Validate improvement
  4. Repeat until targets met

  Target Metrics:
  ┌────────────────────┬────────────┬────────────┐
  │ Metric             │ Current    │ Target     │
  ├────────────────────┼────────────┼────────────┤
  │ Minimal HTML       │ ~190ms     │ <50ms      │
  │ With attrs (400B)  │ ~1,500ms   │ <200ms     │
  │ Scaling factor     │ 1.48x      │ <1.1x      │
  │ ms/element         │ 93-181ms   │ <20ms      │
  └────────────────────┴────────────┴────────────┘
```

### Phase 3: Production Monitoring

**Goal**: Permanent instrumentation for ongoing visibility

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  PHASE 3: STRATEGIC COLLECTOR PLACEMENT                                     │
└─────────────────────────────────────────────────────────────────────────────┘

  After optimization, reduce instrumentation scope:
  
  KEEP @timestamp on:                    REMOVE @timestamp from:
  ─────────────────                      ──────────────────────
  • convert.to_document (entry point)    • process_element (hot loop)
  • convert.to_html (entry point)        • set_attribute (hot loop)
  • document.setup (initialization)      • Inner index operations
  • index.rebuild (expensive operation)  • Hash computation
  • Graph load/save operations           • Per-node operations
  
  
  Collector Placement Options:
  
  Option A: Request-level (API/Service)
  ┌─────────────────────────────────────────────────────────────────┐
  │  class Html_Graph_API:                                          │
  │      def handle_request(self, request):                         │
  │          _timestamp_collector_ = Timestamp_Collector()          │
  │          with _timestamp_collector_:                            │
  │              result = self.process(request)                     │
  │          self.log_metrics(_timestamp_collector_)                │
  │          return result                                          │
  └─────────────────────────────────────────────────────────────────┘
  
  Option B: Optional parameter
  ┌─────────────────────────────────────────────────────────────────┐
  │  def convert(self, html, profile=False):                        │
  │      if profile:                                                │
  │          _timestamp_collector_ = Timestamp_Collector()          │
  │          with _timestamp_collector_:                            │
  │              result = self._do_convert(html)                    │
  │          return result, _timestamp_collector_                   │
  │      return self._do_convert(html)                              │
  └─────────────────────────────────────────────────────────────────┘
  
  Option C: Context-based (e.g., debug mode)
  ┌─────────────────────────────────────────────────────────────────┐
  │  if settings.PERFORMANCE_PROFILING:                             │
  │      _timestamp_collector_ = Timestamp_Collector()              │
  │      with _timestamp_collector_:                                │
  │          # ... operations ...                                   │
  │      metrics_reporter.submit(_timestamp_collector_)             │
  └─────────────────────────────────────────────────────────────────┘
```

---

## Instrumentation Details

### Import Statement

Add to each instrumented file:

```python
from osbot_utils.helpers.timestamp_capture.decorators.timestamp import timestamp
```

---

### Html_MGraph Service Layer

#### File: `html_mgraph/converters/Html__To__Html_MGraph__Document.py`

| Method | Decorator |
|--------|-----------|
| `convert` | `@timestamp(name="html_mgraph.convert.to_document")` |

---

#### File: `html_mgraph/converters/Html_MGraph__Document__To__Html.py`

| Method | Decorator |
|--------|-----------|
| `convert` | `@timestamp(name="html_mgraph.convert.to_html")` |

---

#### File: `html_mgraph/graphs/Html_MGraph__Document.py`

| Method | Decorator |
|--------|-----------|
| `setup` | `@timestamp(name="html_mgraph.document.setup")` |

---

#### File: `html_mgraph/graphs/Html_MGraph__Body__Graph.py`

| Method | Decorator |
|--------|-----------|
| Main build method | `@timestamp(name="html_mgraph.body.build")` |
| Element processing | `@timestamp(name="html_mgraph.body.process_element")` |

---

#### File: `html_mgraph/graphs/Html_MGraph__Head__Graph.py`

| Method | Decorator |
|--------|-----------|
| Main build method | `@timestamp(name="html_mgraph.head.build")` |

---

#### File: `html_mgraph/graphs/Html_MGraph__Attrs__Graph.py`

| Method | Decorator |
|--------|-----------|
| Main build method | `@timestamp(name="html_mgraph.attrs.build")` |
| `register_element` | `@timestamp(name="html_mgraph.attrs.register_element")` |
| `set_attribute` | `@timestamp(name="html_mgraph.attrs.set_attribute")` |

---

#### File: `html_mgraph/graphs/Html_MGraph__Scripts__Graph.py`

| Method | Decorator |
|--------|-----------|
| Main build/add method | `@timestamp(name="html_mgraph.scripts.build")` |

---

#### File: `html_mgraph/graphs/Html_MGraph__Styles__Graph.py`

| Method | Decorator |
|--------|-----------|
| Main build/add method | `@timestamp(name="html_mgraph.styles.build")` |

---

### MGraph-DB Layer

#### File: `mgraph/actions/MGraph__Edit.py`

| Method | Decorator |
|--------|-----------|
| `new_node` | `@timestamp(name="mgraph.edit.new_node")` |
| `new_edge` | `@timestamp(name="mgraph.edit.new_edge")` |
| `new_value` | `@timestamp(name="mgraph.edit.new_value")` |
| `delete_node` | `@timestamp(name="mgraph.edit.delete_node")` |
| `delete_edge` | `@timestamp(name="mgraph.edit.delete_edge")` |

---

#### File: `mgraph/actions/MGraph__Index.py`

| Method | Decorator |
|--------|-----------|
| Node indexing | `@timestamp(name="mgraph.index.add_node")` |
| Edge indexing | `@timestamp(name="mgraph.index.add_edge")` |
| Node removal | `@timestamp(name="mgraph.index.remove_node")` |
| Edge removal | `@timestamp(name="mgraph.index.remove_edge")` |
| Rebuild | `@timestamp(name="mgraph.index.rebuild")` |

---

#### File: `mgraph/actions/MGraph__Index__Values.py`

| Method | Decorator |
|--------|-----------|
| Get or create value | `@timestamp(name="mgraph.index.values.get_or_create")` |
| Hash computation | `@timestamp(name="mgraph.index.values.compute_hash")` |
| Value lookup | `@timestamp(name="mgraph.index.values.lookup")` |

---

## Naming Convention

### Hierarchical Structure

```
html_mgraph.                              # Html_MGraph Service layer
├── convert.
│   ├── to_document                       # HTML string → Document
│   └── to_html                           # Document → HTML string
├── document.
│   └── setup                             # Document initialization
├── body.
│   ├── build                             # Body graph construction
│   └── process_element                   # Per-element (high call count)
├── head.
│   └── build                             # Head graph construction
├── attrs.
│   ├── build                             # Attrs graph construction
│   ├── register_element                  # Register element in attrs
│   └── set_attribute                     # Set single attribute (hot)
├── scripts.
│   └── build                             # Scripts graph
└── styles.
    └── build                             # Styles graph

mgraph.                                   # MGraph-DB layer
├── edit.
│   ├── new_node                          # Create node
│   ├── new_edge                          # Create edge
│   ├── new_value                         # Create value node
│   ├── delete_node                       # Delete node
│   └── delete_edge                       # Delete edge
└── index.
    ├── add_node                          # Index a node
    ├── add_edge                          # Index an edge
    ├── remove_node                       # Remove from index
    ├── remove_edge                       # Remove from index
    ├── rebuild                           # Full index rebuild
    └── values.
        ├── get_or_create                 # Value uniqueness check
        ├── compute_hash                  # Hash computation
        └── lookup                        # Value lookup
```

### Naming Benefits

```
REPORT OUTPUT (sorted by total time):
─────────────────────────────────────────────────────────────────────────────
Method                                        Calls    Total      Self     %
─────────────────────────────────────────────────────────────────────────────
html_mgraph.convert.to_document                   1  1423.1ms   45.2ms  93.4%
html_mgraph.attrs.build                           1   892.5ms  123.5ms  58.6%  ◄─┐
html_mgraph.attrs.set_attribute                  45   654.3ms  654.3ms  43.0%  ◄─┼─ Easy to spot
mgraph.edit.new_node                            156   534.2ms  234.6ms  35.1%    │  attrs-related
mgraph.index.add_node                           156   299.7ms  299.7ms  19.7%  ◄─┘  issues
html_mgraph.body.build                            1   234.2ms   89.3ms  15.4%
─────────────────────────────────────────────────────────────────────────────

Benefits:
✓ Hierarchical grouping (html_mgraph.* vs mgraph.*)
✓ Logical categorization (convert.*, body.*, attrs.*, edit.*, index.*)
✓ Easy filtering (grep for 'attrs' to see all attribute operations)
✓ Clear layer separation
```

---

## Expected Output

### Sample Report

```
================================================================================
Timestamp Report: attrs_html_conversion
================================================================================

  Total Duration : 1,523.45 ms
  Entry Count    : 847
  Methods Traced : 18

Method Timings (sorted by total time):
────────────────────────────────────────────────────────────────────────────────────────────────
Method                                             Calls      Total       Self      Avg   %Total
────────────────────────────────────────────────────────────────────────────────────────────────
html_mgraph.convert.to_document                        1  1423.12ms   45.23ms 1423.12ms    93.4%
html_mgraph.attrs.build                                1   892.45ms  123.45ms  892.45ms    58.6%
html_mgraph.attrs.set_attribute                       45   654.32ms  654.32ms   14.54ms    43.0%
mgraph.edit.new_node                                 156   534.21ms  234.56ms    3.42ms    35.1%
mgraph.index.add_node                                156   299.65ms  299.65ms    1.92ms    19.7%
mgraph.edit.new_value                                 90   245.32ms  145.32ms    2.73ms    16.1%
mgraph.index.values.get_or_create                     90   100.00ms  100.00ms    1.11ms     6.6%
html_mgraph.body.build                                 1    89.34ms   34.21ms   89.34ms     5.9%
html_mgraph.body.process_element                      23    55.13ms   55.13ms    2.40ms     3.6%
html_mgraph.document.setup                             1    45.67ms   45.67ms   45.67ms     3.0%
...
================================================================================
```

### Sample Hotspots Report

```
================================================================================
Top 10 Hotspots (by self-time)
================================================================================
   1. html_mgraph.attrs.set_attribute           654.32ms (43.0%) [45 calls]
   2. mgraph.index.add_node                     299.65ms (19.7%) [156 calls]
   3. mgraph.edit.new_node                      234.56ms (15.4%) [156 calls]
   4. mgraph.edit.new_value                     145.32ms ( 9.5%) [90 calls]
   5. html_mgraph.attrs.build                   123.45ms ( 8.1%) [1 calls]
   6. mgraph.index.values.get_or_create         100.00ms ( 6.6%) [90 calls]
   7. html_mgraph.body.process_element           55.13ms ( 3.6%) [23 calls]
   8. html_mgraph.document.setup                 45.67ms ( 3.0%) [1 calls]
   9. html_mgraph.convert.to_document            45.23ms ( 3.0%) [1 calls]
  10. html_mgraph.body.build                     34.21ms ( 2.2%) [1 calls]
================================================================================

Interpretation:
  • attrs.set_attribute has highest self-time → ACTUAL bottleneck
  • index.add_node called 156 times, 1.92ms each → per-call optimization needed
  • convert.to_document low self-time (45ms) → just orchestrates, not the issue
```

### Sample Timeline

```
================================================================================
Execution Timeline (first 30 entries)
================================================================================
     0.000ms ▶ html_mgraph.convert.to_document
     0.012ms   ▶ html_mgraph.document.setup
    45.678ms   ◀ html_mgraph.document.setup
    45.690ms   ▶ html_mgraph.body.build
    45.702ms     ▶ html_mgraph.body.process_element
    45.815ms       ▶ mgraph.edit.new_node
    47.234ms         ▶ mgraph.index.add_node
    49.156ms         ◀ mgraph.index.add_node
    49.168ms       ◀ mgraph.edit.new_node
    49.180ms     ◀ html_mgraph.body.process_element
    49.192ms     ▶ html_mgraph.body.process_element
    ...
================================================================================
```

---

## Notes

### Implementation Notes

1. **Method names may vary** — Adjust actual method names based on codebase inspection
2. **Start with top-level** — Begin with `convert`, `setup`, `build` methods
3. **Add granularity as needed** — Add more decorators if a method shows high self-time
4. **Hot loops** — Methods like `process_element`, `set_attribute` may have high call counts; this is expected and useful for per-call averaging

### Phase 1 Specific Notes

- Collectors ONLY in test files during investigation
- Fine-grained instrumentation to find exact bottleneck
- No changes to production behavior
- Easy to iterate and experiment

### Future Considerations

- After optimization, reduce decorator count to key entry points
- Consider metrics aggregation/export for production monitoring
- Evaluate collector placement strategy based on usage patterns

---

## Quick Reference

### Adding a new @timestamp

```python
# 1. Import
from osbot_utils.helpers.timestamp_capture.decorators.timestamp import timestamp

# 2. Decorate
@timestamp(name="layer.category.operation")
def my_method(self, ...):
    ...
```

### Creating a test with collector

```python
from osbot_utils.helpers.timestamp_capture.Timestamp_Collector         import Timestamp_Collector
from osbot_utils.helpers.timestamp_capture.Timestamp_Collector__Report import Timestamp_Collector__Report

def test_performance():
    _timestamp_collector_ = Timestamp_Collector(name="my_test")
    
    with _timestamp_collector_:
        # ... call decorated methods ...
        result = converter.convert(html)
    
    report = Timestamp_Collector__Report(collector=_timestamp_collector_)
    report.print_report()
    report.print_hotspots()
```

### Key Files to Modify

```
MGraph-AI__Service__Html__Graph/
├── html_mgraph/
│   ├── converters/
│   │   ├── Html__To__Html_MGraph__Document.py      ← @timestamp
│   │   └── Html_MGraph__Document__To__Html.py      ← @timestamp
│   └── graphs/
│       ├── Html_MGraph__Document.py                ← @timestamp
│       ├── Html_MGraph__Body__Graph.py             ← @timestamp
│       ├── Html_MGraph__Head__Graph.py             ← @timestamp
│       ├── Html_MGraph__Attrs__Graph.py            ← @timestamp
│       ├── Html_MGraph__Scripts__Graph.py          ← @timestamp
│       └── Html_MGraph__Styles__Graph.py           ← @timestamp

MGraph-DB/
└── mgraph/
    └── actions/
        ├── MGraph__Edit.py                         ← @timestamp
        ├── MGraph__Index.py                        ← @timestamp
        └── MGraph__Index__Values.py                ← @timestamp
```