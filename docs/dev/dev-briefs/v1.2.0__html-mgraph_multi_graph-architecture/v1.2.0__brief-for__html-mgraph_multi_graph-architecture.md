# Html_MGraph Multi-Graph Architecture - LLM Implementation Briefing

**Version**: v1.2.0
**Date**: December 2025
**Repository**: the-cyber-boardroom/MGraph-AI__Service__Html__Graph

---

## Executive Summary

This document describes a new multi-graph architecture for `Html_MGraph` that enables **full round-trip HTML manipulation** (HTML → Graph → Transform → Graph → HTML). The key insight is separating a single complex graph into **5 specialized graphs + 1 orchestrator**, each with a focused responsibility, while sharing `Node_Id` values to enable seamless recombination.

### The Core Innovation

Instead of one monolithic graph containing elements, tags, attributes, text, scripts, and styles, we create:

| Graph | Purpose | Visualization Complexity |
|-------|---------|-------------------------|
| `Html_MGraph__Document` | Orchestrator holding references to other graphs | Minimal (5-6 nodes) |
| `Html_MGraph__Head` | `<head>` element structure + text content | Low |
| `Html_MGraph__Body` | `<body>` element structure + text content | Medium (main working graph) |
| `Html_MGraph__Attributes` | Tags and attributes for ALL elements | Medium |
| `Html_MGraph__Scripts` | JavaScript content from `<script>` tags | Low |
| `Html_MGraph__Styles` | CSS content from `<style>` tags | Low |

---

## Part 1: Problem Statement & Evolution

### 1.1 The Original Goal

Create a graph representation of HTML that allows:
1. **Visualization** - See HTML structure as a graph
2. **Manipulation** - Transform the graph (collapse nodes, merge text, etc.)
3. **Round-trip** - Convert back to valid HTML after transformations

### 1.2 The Current Implementation (v1.x)

The current `Html_MGraph` creates a **single graph** with:

```
Element Node (e.g., "body.div")
    ├──[tag]──► Tag Value Node ("div")
    ├──[attr:class]──► Attr Value Node ("container")
    ├──[attr:id]──► Attr Value Node ("main")
    ├──[child:0]──► Child Element Node
    └──[text:0]──► Text Value Node ("Hello World")
```

**Current Pipeline:**
```
HTML String
    ↓ Html__To__Html_Dict (osbot_utils)
Html_Dict (OSBot format: {tag, attrs, nodes: [...]})
    ↓ Html_Dict__OSBot__To__Html_Dict (ADAPTER - unnecessary indirection)
Html_Dict (MGraph format: {tag, attrs, child_nodes: [...], text_nodes: [...]})
    ↓ Html_Dict__To__Html_MGraph
Html_MGraph (single graph)
    ↓ [transformations]
Html_MGraph
    ↓ Html_MGraph__To__Html_Dict
Html_Dict
    ↓ Html_Dict__To__Html (osbot_utils) - INCOMPLETE/BROKEN
HTML String (round-trip fails)
```

### 1.3 Problems with Single-Graph Approach

#### Problem 1: Visualization Complexity
Every element has edges to tag nodes, attribute nodes, and potentially text nodes. A simple HTML document explodes into dozens of nodes:

```html
<div class="main" id="app">Hello</div>
```

Becomes 5 nodes + 4 edges:
- Element node (div)
- Tag node ("div")
- Attr node ("main")
- Attr node ("app")
- Text node ("Hello")

For complex pages, the graph becomes unreadable.

#### Problem 2: Manipulation Difficulty
When performing transformations (like `Html_Use_Case__2` which collapses single-child parents and merges text), you must carefully preserve tag and attribute edges that aren't relevant to the manipulation.

#### Problem 3: Head Section Noise
The `<head>` contains metadata, scripts, and styles that clutter visualization but are essential for round-trip. You can't simply discard them.

#### Problem 4: Script/Style Content
JavaScript and CSS appear as text nodes, but they're code that:
- Should not be treated as content
- Will eventually need AST parsing
- Clutter the content-focused manipulation

#### Problem 5: Legacy Adapter Layer
The pipeline requires `Html_Dict__OSBot__To__Html_Dict` to convert between two dict formats, adding unnecessary complexity.

### 1.4 Experiments and Iterations

#### Experiment 1: Config Flags
Added `Schema__Config__Html_Dict__To__Html_MGraph`:
```python
config.add_tag_nodes       = False
config.add_attribute_nodes = False
```

**Result**: Simplified graph but **broke round-trip** - couldn't reconstruct HTML without tag/attribute information.

#### Experiment 2: Transformation Pipeline
Created 5-phase transformation system in `Graph_Transformation__Base`:
1. `transform_html()` - Modify raw HTML
2. `transform_dict()` - Modify parsed dict
3. `create_mgraph()` - Custom graph creation
4. `transform_mgraph()` - Modify graph structure
5. `transform_export()` - Modify export data

**Result**: Enabled transformations like `Html_Use_Case__2` but round-trip still broken because transformations destroyed information needed for reconstruction.

#### Experiment 3: Body-Only Transformation
`Graph_Transformation__Body_Only` extracts just `<body>` content.

**Result**: Cleaner visualization but **loses `<head>` entirely** - no round-trip possible.

### 1.5 The Key Insight

The problem isn't the transformations - it's that **one graph is trying to serve multiple purposes**:

1. **Manipulation** needs: elements + text (clean, simple)
2. **Visualization** needs: same as manipulation
3. **Round-trip** needs: tags, attributes, head, scripts, styles (complete fidelity)

**Solution**: Separate these concerns into multiple graphs that share `Node_Id` values for recombination.

---

## Part 2: New Multi-Graph Architecture

### 2.1 Architecture Overview

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Html_MGraph__Document                            │
│                        (Orchestrator Graph)                             │
│                                                                         │
│   root_id: d0 (represents <html> element)                               │
│                                                                         │
│   d0 ──[graph:head]──► h1    (root of Html_MGraph__Head)               │
│   d0 ──[graph:body]──► n1    (root of Html_MGraph__Body)               │
│   d0 ──[graph:attrs]──► a0   (root of Html_MGraph__Attributes)         │
│   d0 ──[graph:scripts]──► s0 (root of Html_MGraph__Scripts)            │
│   d0 ──[graph:styles]──► t0  (root of Html_MGraph__Styles)             │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
          │              │              │              │              │
          ▼              ▼              ▼              ▼              ▼
┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌──────────┐  ┌──────────┐
│Html_MGraph  │  │Html_MGraph  │  │Html_MGraph  │  │Html_MGraph│  │Html_MGraph│
│__Head       │  │__Body       │  │__Attributes │  │__Scripts │  │__Styles  │
│             │  │             │  │             │  │          │  │          │
│ elements +  │  │ elements +  │  │ tags +      │  │ JS code  │  │ CSS code │
│ text only   │  │ text only   │  │ attributes  │  │          │  │          │
└─────────────┘  └─────────────┘  └─────────────┘  └──────────┘  └──────────┘
```

### 2.2 Shared Node_Id Principle

**Critical Design Rule**: Element nodes use the **same `Node_Id`** across all graphs.

Example: A `<div>` element with id `n2`:
- In `Html_MGraph__Body`: `n2` is an element node with child/text edges
- In `Html_MGraph__Attributes`: `n2` appears under the `div` tag node with attribute edges
- In `Html_MGraph__Scripts`: (only if it's a `<script>` element)

This enables:
```python
# Get tag for element
tag = attrs_graph.get_parent(node_id).value  # "div"

# Get attributes for element
attrs = attrs_graph.get_outgoing_edges(node_id)  # {class: "main", id: "app"}

# Get children for element
children = body_graph.get_children(node_id)
```

### 2.3 Every Graph Has a Root Node

Each graph has a single root node that all other nodes connect to (directly or transitively):

| Graph | Root Node | Represents |
|-------|-----------|------------|
| `Html_MGraph__Document` | `d0` | The `<html>` element |
| `Html_MGraph__Head` | `h1` | The `<head>` element |
| `Html_MGraph__Body` | `n1` | The `<body>` element |
| `Html_MGraph__Attributes` | `a0` | Synthetic root for tag hierarchy |
| `Html_MGraph__Scripts` | `s0` | Synthetic root for script elements |
| `Html_MGraph__Styles` | `t0` | Synthetic root for style elements |

---

## Part 3: Detailed Graph Specifications

### 3.1 Html_MGraph__Document

**Purpose**: Orchestrator that holds references to all other graphs and represents the `<html>` element.

```
┌─────────────────────────────────────────────────────────────────────┐
│                      Html_MGraph__Document                          │
│                                                                     │
│   graph_path: "document"                                            │
│   root_id: d0                                                       │
│                                                                     │
│   Nodes:                                                            │
│   ┌─────────────────────────────────────────────────────────────┐  │
│   │ node_id: d0                                                 │  │
│   │ node_path: "html"                                           │  │
│   │ (represents the <html> element itself)                      │  │
│   └─────────────────────────────────────────────────────────────┘  │
│                                                                     │
│   Edges (from d0):                                                  │
│   ┌─────────────────────────────────────────────────────────────┐  │
│   │ d0 ──[edge_path: "head"]──► h1 (value: root_id of Head)     │  │
│   │ d0 ──[edge_path: "body"]──► n1 (value: root_id of Body)     │  │
│   │ d0 ──[edge_path: "attrs"]──► a0 (value: root_id of Attrs)   │  │
│   │ d0 ──[edge_path: "scripts"]──► s0 (value: root_id of Scripts│  │
│   │ d0 ──[edge_path: "styles"]──► t0 (value: root_id of Styles) │  │
│   └─────────────────────────────────────────────────────────────┘  │
│                                                                     │
│   The target nodes (h1, n1, a0, s0, t0) are value nodes storing    │
│   the root Node_Id of each respective graph.                       │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**Key Points**:
- `d0` is the `<html>` element's node_id (shared with Attributes graph)
- Target nodes store the root_id as a value for lookup
- Minimal graph - just 6 nodes, 5 edges

### 3.2 Html_MGraph__Head

**Purpose**: Element structure and text content from `<head>`. No script/style content (those go to their respective graphs).

```
┌─────────────────────────────────────────────────────────────────────┐
│                        Html_MGraph__Head                            │
│                                                                     │
│   graph_path: "head"                                                │
│   root_id: h1                                                       │
│                                                                     │
│   Example structure for:                                            │
│   <head>                                                            │
│       <meta charset="utf-8">                                        │
│       <title>My Page</title>                                        │
│       <style>.container { ... }</style>                             │
│       <script>console.log('init')</script>                          │
│   </head>                                                           │
│                                                                     │
│   Nodes:                                                            │
│   h1 - head element      (node_path: "head")                        │
│   h2 - meta element      (node_path: "head.meta")                   │
│   h3 - title element     (node_path: "head.title")                  │
│   h4 - style element     (node_path: "head.style")                  │
│   h5 - script element    (node_path: "head.script")                 │
│   v1 - text value        (node_path: "text", value: "My Page")      │
│                                                                     │
│   Edges:                                                            │
│   h1 ──[predicate: child, edge_path: "0"]──► h2                     │
│   h1 ──[predicate: child, edge_path: "1"]──► h3                     │
│   h1 ──[predicate: child, edge_path: "2"]──► h4                     │
│   h1 ──[predicate: child, edge_path: "3"]──► h5                     │
│   h3 ──[predicate: text,  edge_path: "0"]──► v1                     │
│                                                                     │
│   NOTE: h4 (style) and h5 (script) have NO text edges here.        │
│   Their content lives in Html_MGraph__Styles and __Scripts.        │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**Key Points**:
- `<style>` and `<script>` elements exist as nodes (for DOM structure) but have no text content edges
- Text content (like `<title>`) uses `text` predicate edges
- `edge_path` stores position for ordering

### 3.3 Html_MGraph__Body

**Purpose**: Element structure and text content from `<body>`. This is the **primary working graph** for manipulation and visualization.

```
┌─────────────────────────────────────────────────────────────────────┐
│                        Html_MGraph__Body                            │
│                                                                     │
│   graph_path: "body"                                                │
│   root_id: n1                                                       │
│                                                                     │
│   Example structure for:                                            │
│   <body class="container">                                          │
│       <div class="main" id="app">                                   │
│           Hello <b>World</b>                                        │
│       </div>                                                        │
│       <script>initApp()</script>                                    │
│   </body>                                                           │
│                                                                     │
│   Nodes:                                                            │
│   n1 - body element      (node_path: "body")                        │
│   n2 - div element       (node_path: "body.div")                    │
│   n3 - b element         (node_path: "body.div.b")                  │
│   n4 - script element    (node_path: "body.script")                 │
│   v1 - text value        (node_path: "text", value: "Hello ")       │
│   v2 - text value        (node_path: "text", value: "World")        │
│                                                                     │
│   Edges:                                                            │
│   n1 ──[predicate: child, edge_path: "0"]──► n2                     │
│   n1 ──[predicate: child, edge_path: "1"]──► n4                     │
│   n2 ──[predicate: text,  edge_path: "0"]──► v1                     │
│   n2 ──[predicate: child, edge_path: "1"]──► n3                     │
│   n3 ──[predicate: text,  edge_path: "0"]──► v2                     │
│                                                                     │
│   NOTE: n4 (script) has NO text edge - content in Scripts graph.   │
│                                                                     │
│   VISUALIZATION: This graph alone provides clean element + text    │
│   structure perfect for display and manipulation.                   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**Key Points**:
- Clean element + text structure only
- No tag nodes cluttering the graph
- No attribute nodes cluttering the graph
- Perfect for visualization with tools like vis.js, D3, Graphviz
- This is where transformations like `Html_Use_Case__2` operate

### 3.4 Html_MGraph__Attributes

**Purpose**: Tags and attributes for ALL elements (from Document, Head, and Body). Uses a hierarchical structure: `root → tag → element → attribute`.

```
┌─────────────────────────────────────────────────────────────────────┐
│                     Html_MGraph__Attributes                         │
│                                                                     │
│   graph_path: "attributes"                                          │
│   root_id: a0                                                       │
│                                                                     │
│   STRUCTURE: root ──► tag_node ──► element_node ──► attr_value     │
│                                                                     │
│   Example for complete document:                                    │
│   <html lang="en">                                                  │
│       <head>                                                        │
│           <meta charset="utf-8">                                    │
│       </head>                                                       │
│       <body class="container">                                      │
│           <div class="main" id="app">...</div>                      │
│       </body>                                                       │
│   </html>                                                           │
│                                                                     │
│                            a0 (root)                                │
│           __________________|__________________                     │
│          /       |       |       |       \     \                    │
│        html    head    meta    body     div   ...  (TAG nodes)      │
│         |       |       |       |        |                          │
│        d0      h1      h2      n1       n2         (ELEMENT nodes)  │
│         |               |       |      /   \        same IDs as     │
│        v1              v2      v3    v4    v5      Head/Body graphs │
│                                                                     │
│   Tag nodes (value = tag name):                                     │
│   - node_path: "tag:html", value: "html"                            │
│   - node_path: "tag:head", value: "head"                            │
│   - node_path: "tag:meta", value: "meta"                            │
│   - node_path: "tag:body", value: "body"                            │
│   - node_path: "tag:div",  value: "div"                             │
│                                                                     │
│   Element nodes (anchor nodes - same Node_Id as in Head/Body):      │
│   - node_id: d0 (html element - same as Document root)              │
│   - node_id: h1 (head element - same as Head root)                  │
│   - node_id: h2 (meta element - same as in Head graph)              │
│   - node_id: n1 (body element - same as Body root)                  │
│   - node_id: n2 (div element - same as in Body graph)               │
│                                                                     │
│   Attribute value nodes:                                            │
│   - v1: node_path: "0", value: "en"        (lang attr of html)      │
│   - v2: node_path: "0", value: "utf-8"     (charset attr of meta)   │
│   - v3: node_path: "0", value: "container" (class attr of body)     │
│   - v4: node_path: "0", value: "main"      (class attr of div)      │
│   - v5: node_path: "1", value: "app"       (id attr of div)         │
│                                                                     │
│   Edges:                                                            │
│   a0 ──[predicate: tag]──► tag:html                                 │
│   a0 ──[predicate: tag]──► tag:head                                 │
│   a0 ──[predicate: tag]──► tag:meta                                 │
│   ... (one edge per unique tag)                                     │
│                                                                     │
│   tag:html ──[predicate: element]──► d0                             │
│   tag:head ──[predicate: element]──► h1                             │
│   tag:meta ──[predicate: element]──► h2                             │
│   tag:body ──[predicate: element]──► n1                             │
│   tag:div  ──[predicate: element]──► n2                             │
│                                                                     │
│   d0 ──[predicate: attr, edge_path: "lang"]──► v1                   │
│   h2 ──[predicate: attr, edge_path: "charset"]──► v2                │
│   n1 ──[predicate: attr, edge_path: "class"]──► v3                  │
│   n2 ──[predicate: attr, edge_path: "class"]──► v4                  │
│   n2 ──[predicate: attr, edge_path: "id"]──► v5                     │
│                                                                     │
│   ATTRIBUTE ORDERING:                                               │
│   - edge_path = attribute name (for semantic lookup)                │
│   - node_path on value node = position (for round-trip ordering)    │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**Key Points**:
- Hierarchical: `root → tag → element → attribute`
- Tag nodes group elements by type (all `<div>`s under one tag node)
- Element nodes share `Node_Id` with Head/Body graphs
- Getting an element's tag: traverse UP one edge from element node
- Getting elements by tag: get children of tag node
- Attribute order preserved in `node_path` of value nodes

### 3.5 Html_MGraph__Scripts

**Purpose**: JavaScript content from `<script>` elements. Prepared for future AST parsing.

```
┌─────────────────────────────────────────────────────────────────────┐
│                      Html_MGraph__Scripts                           │
│                                                                     │
│   graph_path: "scripts"                                             │
│   root_id: s0                                                       │
│                                                                     │
│   Example for:                                                      │
│   <head>                                                            │
│       <script>console.log('head script')</script>                   │
│   </head>                                                           │
│   <body>                                                            │
│       <script src="app.js"></script>           <!-- external -->    │
│       <script>function init() { ... }</script> <!-- inline -->      │
│   </body>                                                           │
│                                                                     │
│   Nodes:                                                            │
│   s0 - root node         (node_path: "scripts")                     │
│   h5 - script element    (same node_id as in Head graph)            │
│   n4 - script element    (same node_id as in Body graph, external)  │
│   n7 - script element    (same node_id as in Body graph, inline)    │
│   c1 - content value     (node_path: "0", value: "console.log...")  │
│   c2 - content value     (node_path: "0", value: "function init..." │
│                                                                     │
│   Edges:                                                            │
│   s0 ──[predicate: script, edge_path: "0"]──► h5                    │
│   s0 ──[predicate: script, edge_path: "1"]──► n4                    │
│   s0 ──[predicate: script, edge_path: "2"]──► n7                    │
│                                                                     │
│   h5 ──[predicate: content, edge_path: "0"]──► c1                   │
│   n7 ──[predicate: content, edge_path: "0"]──► c2                   │
│                                                                     │
│   NOTE: n4 has NO content edge (external script with src attr)      │
│   The src attribute lives in Html_MGraph__Attributes                │
│                                                                     │
│   FUTURE EXTENSION:                                                 │
│   h5 ──[predicate: ast, edge_path: "0"]──► (JS AST subgraph)        │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**Key Points**:
- Script element nodes share `Node_Id` with Head/Body
- External scripts (with `src`) have no content edges (src is in Attributes)
- Inline scripts have content edges to value nodes
- `node_path` on content value = position (for multiple script blocks)
- Future: AST edges for parsed JavaScript

### 3.6 Html_MGraph__Styles

**Purpose**: CSS content from `<style>` elements. Prepared for future AST parsing.

```
┌─────────────────────────────────────────────────────────────────────┐
│                      Html_MGraph__Styles                            │
│                                                                     │
│   graph_path: "styles"                                              │
│   root_id: t0                                                       │
│                                                                     │
│   Example for:                                                      │
│   <head>                                                            │
│       <style>.container { display: flex; }</style>                  │
│       <link rel="stylesheet" href="app.css">   <!-- external -->    │
│   </head>                                                           │
│                                                                     │
│   Nodes:                                                            │
│   t0 - root node         (node_path: "styles")                      │
│   h4 - style element     (same node_id as in Head graph)            │
│   h6 - link element      (same node_id as in Head graph, external)  │
│   c1 - content value     (node_path: "0", value: ".container...")   │
│                                                                     │
│   Edges:                                                            │
│   t0 ──[predicate: style, edge_path: "0"]──► h4                     │
│   t0 ──[predicate: style, edge_path: "1"]──► h6                     │
│                                                                     │
│   h4 ──[predicate: content, edge_path: "0"]──► c1                   │
│                                                                     │
│   NOTE: h6 (link) has NO content edge (external stylesheet)         │
│   The href attribute lives in Html_MGraph__Attributes               │
│                                                                     │
│   FUTURE EXTENSION:                                                 │
│   h4 ──[predicate: ast, edge_path: "0"]──► (CSS AST subgraph)       │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**Key Points**:
- Style element nodes share `Node_Id` with Head graph
- External stylesheets (`<link>`) have no content edges
- `node_path` on content value = position
- Future: AST edges for parsed CSS

---

## Part 4: Implementation Classes

### 4.1 Class Hierarchy

```python
# Base class (existing)
class Html_MGraph(Type_Safe):
    mgraph     : MGraph
    path_utils : Html_MGraph__Path
    root_id    : Node_Id

# Specialized graphs (new)
class Html_MGraph__Document(Html_MGraph):
    """Orchestrator holding references to other graphs."""
    head_graph   : Html_MGraph__Head
    body_graph   : Html_MGraph__Body
    attrs_graph  : Html_MGraph__Attributes
    scripts_graph: Html_MGraph__Scripts
    styles_graph : Html_MGraph__Styles

class Html_MGraph__Head(Html_MGraph):
    """<head> element structure + text content only."""
    pass

class Html_MGraph__Body(Html_MGraph):
    """<body> element structure + text content only."""
    pass

class Html_MGraph__Attributes(Html_MGraph):
    """Tags and attributes for all elements."""
    pass

class Html_MGraph__Scripts(Html_MGraph):
    """JavaScript content from <script> elements."""
    pass

class Html_MGraph__Styles(Html_MGraph):
    """CSS content from <style> elements."""
    pass
```

### 4.2 Conversion Classes

```python
# Forward conversion (HTML → Graphs)
class Html__To__Html_MGraph__Document(Type_Safe):
    """Convert HTML string to multi-graph structure."""

    def convert(self, html: Safe_Str__Html) -> Html_MGraph__Document:
        # 1. Parse HTML to dict
        html_dict = Html__To__Html_Dict(html=html).convert()

        # 2. Create all graphs with shared Node_Id generation
        document = self._create_document_graph(html_dict)

        return document

# Reverse conversion (Graphs → HTML) - THE ROUND-TRIP
class Html_MGraph__Document__To__Html(Type_Safe):
    """Convert multi-graph structure back to HTML string."""

    def convert(self, document: Html_MGraph__Document) -> Safe_Str__Html:
        # 1. Walk Body/Head graphs for structure
        # 2. Look up tags from Attributes graph
        # 3. Look up attributes from Attributes graph
        # 4. Look up script content from Scripts graph
        # 5. Look up style content from Styles graph
        # 6. Reconstruct HTML
        pass
```

### 4.3 Key Helper Methods

```python
class Html_MGraph__Document(Html_MGraph):

    def get_tag(self, node_id: Node_Id) -> str:
        """Get HTML tag for any element node."""
        parent = self.attrs_graph.get_parent(node_id)
        return self.attrs_graph.get_value(parent)

    def get_attributes(self, node_id: Node_Id) -> Dict[str, str]:
        """Get all attributes for an element, preserving order."""
        edges = self.attrs_graph.get_outgoing_edges(node_id)
        attrs = []
        for edge in edges:
            if edge.predicate == 'attr':
                target = self.attrs_graph.get_node(edge.to_node_id)
                position = int(target.node_path)
                attrs.append((position, edge.edge_path, target.value))
        attrs.sort(key=lambda x: x[0])
        return {name: value for _, name, value in attrs}

    def get_elements_by_tag(self, tag: str) -> List[Node_Id]:
        """Find all elements with given tag."""
        tag_node = self.attrs_graph.find_node_by_path(f"tag:{tag}")
        if not tag_node:
            return []
        return self.attrs_graph.get_children(tag_node.node_id)

    def get_script_content(self, node_id: Node_Id) -> Optional[str]:
        """Get JavaScript content for a script element."""
        edges = self.scripts_graph.get_outgoing_edges(node_id)
        for edge in edges:
            if edge.predicate == 'content':
                return self.scripts_graph.get_value(edge.to_node_id)
        return None

    def get_style_content(self, node_id: Node_Id) -> Optional[str]:
        """Get CSS content for a style element."""
        edges = self.styles_graph.get_outgoing_edges(node_id)
        for edge in edges:
            if edge.predicate == 'content':
                return self.styles_graph.get_value(edge.to_node_id)
        return None
```

---

## Part 5: Round-Trip Pipeline

### 5.1 Forward Pipeline (HTML → Graphs)

```
HTML String
    │
    ▼
Html__To__Html_Dict (osbot_utils)
    │
    ▼
Html_Dict (OSBot format: {tag, attrs, nodes: [...]})
    │
    ▼
Html__To__Html_MGraph__Document
    │
    ├──► Extract <html> element → d0
    ├──► Extract <head> subtree → Html_MGraph__Head (root: h1)
    ├──► Extract <body> subtree → Html_MGraph__Body (root: n1)
    ├──► Extract all tags/attrs → Html_MGraph__Attributes (root: a0)
    ├──► Extract script content → Html_MGraph__Scripts (root: s0)
    └──► Extract style content  → Html_MGraph__Styles (root: t0)
    │
    ▼
Html_MGraph__Document (containing all 5 graphs)
```

### 5.2 Transformation (optional)

```
Html_MGraph__Document
    │
    ▼
Access body_graph for manipulation
    │
    ├──► Collapse single-child parents
    ├──► Merge text nodes
    ├──► Remove empty elements
    └──► (other transformations)
    │
    ▼
Modified Html_MGraph__Document
```

### 5.3 Reverse Pipeline (Graphs → HTML)

```
Html_MGraph__Document
    │
    ▼
Html_MGraph__Document__To__Html
    │
    ├──► Start with <html> (d0)
    ├──► Get tag from attrs_graph: "html"
    ├──► Get attributes from attrs_graph: {lang: "en"}
    ├──► Recurse into <head> (h1)
    │    ├──► For each child in head_graph
    │    ├──► Get tag from attrs_graph
    │    ├──► Get attributes from attrs_graph
    │    ├──► If <script>: get content from scripts_graph
    │    ├──► If <style>: get content from styles_graph
    │    └──► Else: get text from head_graph
    ├──► Recurse into <body> (n1)
    │    └──► (same pattern as head)
    │
    ▼
Html_Dict (OSBot format)
    │
    ▼
Html_Dict__To__Html (osbot_utils)
    │
    ▼
HTML String (round-trip complete!)
```

---

## Part 6: Migration Path

### 6.1 Backward Compatibility

The existing `Html_MGraph` class remains for simple use cases. New multi-graph architecture is opt-in:

```python
# Old way (still works)
html_mgraph = Html_MGraph.from_html_dict(html_dict)

# New way (multi-graph)
html_document = Html__To__Html_MGraph__Document().convert(html)
```

### 6.2 Deprecation of Legacy Adapter

`Html_Dict__OSBot__To__Html_Dict` should be deprecated. The refactored `Html_Dict__To__Html_MGraph` handles both OSBot and separated formats directly.

### 6.3 Implementation Order

1. **Phase 1**: Refactor `Html_Dict__To__Html_MGraph` to handle OSBot format directly (DONE - see refactored code)
2. **Phase 2**: Implement `Html_MGraph__Body` and `Html_MGraph__Head`
3. **Phase 3**: Implement `Html_MGraph__Attributes` with tag hierarchy
4. **Phase 4**: Implement `Html_MGraph__Scripts` and `Html_MGraph__Styles`
5. **Phase 5**: Implement `Html_MGraph__Document` orchestrator
6. **Phase 6**: Implement `Html_MGraph__Document__To__Html` for round-trip
7. **Phase 7**: Migrate transformations to work with new structure

---

## Part 7: Key Design Decisions Summary

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Number of graphs | 5 + 1 orchestrator | Clear separation of concerns |
| Shared Node_Ids | Yes | Enables cross-graph lookups |
| Tags in Attributes graph | Yes (as intermediate layer) | Eliminates separate Tags graph, provides natural grouping |
| Attribute ordering | node_path on value nodes | Preserves order for round-trip |
| Script/Style content | Separate graphs | Clean for future AST parsing |
| Root nodes | Every graph has one | Enables traversal from known starting point |
| Graph storage | All MGraph instances | Consistent API, future-proof |

---

## Appendix A: Example HTML Document

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>My Page</title>
    <style>.container { display: flex; }</style>
    <script>console.log('init');</script>
</head>
<body class="container">
    <div class="main" id="app">
        Hello <b>World</b>
    </div>
    <script>initApp();</script>
</body>
</html>
```

### Resulting Node_Ids

| Node_Id | Element | Graph(s) Present In |
|---------|---------|---------------------|
| d0 | `<html>` | Document, Attributes |
| h1 | `<head>` | Document, Head, Attributes |
| h2 | `<meta>` | Head, Attributes |
| h3 | `<title>` | Head, Attributes |
| h4 | `<style>` | Head, Attributes, Styles |
| h5 | `<script>` (head) | Head, Attributes, Scripts |
| n1 | `<body>` | Document, Body, Attributes |
| n2 | `<div>` | Body, Attributes |
| n3 | `<b>` | Body, Attributes |
| n4 | `<script>` (body) | Body, Attributes, Scripts |

---

## Appendix B: File Structure

```
mgraph_ai_service_html_graph/
└── service/
    └── html_graph/
        ├── Html_MGraph.py                    # Existing base class
        ├── Html_MGraph__Document.py          # NEW: Orchestrator
        ├── Html_MGraph__Head.py              # NEW: Head graph
        ├── Html_MGraph__Body.py              # NEW: Body graph
        ├── Html_MGraph__Attributes.py        # NEW: Tags + Attributes
        ├── Html_MGraph__Scripts.py           # NEW: Script content
        ├── Html_MGraph__Styles.py            # NEW: Style content
        ├── Html__To__Html_MGraph__Document.py  # NEW: Forward conversion
        ├── Html_MGraph__Document__To__Html.py  # NEW: Reverse conversion
        ├── Html_Dict__To__Html_MGraph.py     # REFACTORED: Handles OSBot format
        ├── Html__To__Html_MGraph.py          # SIMPLIFIED: No adapter
        └── Html_Dict__OSBot__To__Html_Dict.py  # DEPRECATED
```
